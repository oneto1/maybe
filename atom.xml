<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>oneto1</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-08-02T09:56:36.280Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>oneto1</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>💁🏻‍♂️</title>
    <link href="http://yoursite.com/2020/08/02/%F0%9F%92%81%F0%9F%8F%BB%E2%80%8D%E2%99%82%EF%B8%8F/"/>
    <id>http://yoursite.com/2020/08/02/%F0%9F%92%81%F0%9F%8F%BB%E2%80%8D%E2%99%82%EF%B8%8F/</id>
    <published>2020-08-02T09:49:03.000Z</published>
    <updated>2020-08-02T09:56:36.280Z</updated>
    
    <content type="html"><![CDATA[<p>时间过得真快啊,一下子就快实习了两个月了,虽然这也不是什么断更的理由</p><p>那么就接下来继续努力吧</p><p><img src="/images/990672b3e82963502a597c34e55546b5.gif" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;时间过得真快啊,一下子就快实习了两个月了,虽然这也不是什么断更的理由&lt;/p&gt;
&lt;p&gt;那么就接下来继续努力吧&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/990672b3e82963502a597c34e55546b5.gif&quot; alt&gt;&lt;/p&gt;

      
    
    </summary>
    
    
    
      <category term="乱七八糟" scheme="http://yoursite.com/tags/%E4%B9%B1%E4%B8%83%E5%85%AB%E7%B3%9F/"/>
    
  </entry>
  
  <entry>
    <title>翻译: ansible-tuto（12-13）</title>
    <link href="http://yoursite.com/2020/05/18/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8812-13%EF%BC%89/"/>
    <id>http://yoursite.com/2020/05/18/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8812-13%EF%BC%89/</id>
    <published>2020-05-18T02:26:33.000Z</published>
    <updated>2020-05-18T02:49:23.578Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="step-12-迁移到-role"><a href="#step-12-迁移到-role" class="headerlink" title="step-12 迁移到 role"></a>step-12 迁移到 role</h1><p>现在我们的剧本完成了，让我们重构一切！ 我们将用 <code>role</code> 来取代我们的戏剧。  <code>role</code>只是一种组织文件的新方式，但是带来了有趣的特性。 在这里我不会详细讨论，因为它们已经列出在 Ansible 的文档中，但我最喜欢的可能是 <code>role</code>依赖性:  <code>role</code> b 可以依赖于另一个 <code>role</code> a，因此，当应用 <code>role</code> b 时， <code>role</code> a 也会自动应用。 我们将在下一章中看到这一点，但是现在，让我们重构一下我们的剧本，使用 <code>role</code>。</p><h3 id="role-的结构"><a href="#role-的结构" class="headerlink" title="role 的结构"></a>role 的结构</h3><p>role 为 Ansible 添加了一点“魔力” : 它们假定一个特定的文件组织。 虽然有一个关于角色的建议布局，但是您可以按照您想要的方式来组织包含内容。 然而，role  的约定有助于构建模块化的剧本，并且内务管理将简单得多。 Rubyists 会称之为“约定优于配置”。</p><p>role 的文件布局如下:<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">roles</span><br><span class="line">  |</span><br><span class="line"><span class="string">  </span>|_some_role</span><br><span class="line">       |</span><br><span class="line"><span class="string">       </span>|_defaults</span><br><span class="line">       |<span class="string">   </span>|</span><br><span class="line">       |<span class="string">   </span>|<span class="string">_main.yml</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|<span class="string">_...</span></span><br><span class="line"><span class="string">       </span>|</span><br><span class="line">       |<span class="string">_files</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|</span><br><span class="line">       |<span class="string">   </span>|_file1</span><br><span class="line">       |<span class="string">   </span>|<span class="string">_...</span></span><br><span class="line"><span class="string">       </span>|</span><br><span class="line">       |<span class="string">_handlers</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|</span><br><span class="line">       |<span class="string">   </span>|<span class="string">_main.yml</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|<span class="string">_some_other_file.yml</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|<span class="string">_ ...</span></span><br><span class="line"><span class="string">       </span>|</span><br><span class="line">       |<span class="string">_meta</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|</span><br><span class="line">       |<span class="string">   </span>|<span class="string">_main.yml</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|<span class="string">_some_other_file.yml</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|<span class="string">_ ...</span></span><br><span class="line"><span class="string">       </span>|</span><br><span class="line">       |<span class="string">_tasks</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|</span><br><span class="line">       |<span class="string">   </span>|<span class="string">_main.yml</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|<span class="string">_some_other_file.yml</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|<span class="string">_ ...</span></span><br><span class="line"><span class="string">       </span>|</span><br><span class="line">       |<span class="string">_templates</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|</span><br><span class="line">       |<span class="string">   </span>|<span class="string">_template1.j2</span></span><br><span class="line"><span class="string">       </span>|<span class="string">   </span>|<span class="string">_...</span></span><br><span class="line"><span class="string">       </span>|</span><br><span class="line">       |<span class="string">_vars</span></span><br><span class="line"><span class="string">           </span>|</span><br><span class="line">           |<span class="string">_main.yml</span></span><br><span class="line"><span class="string">           </span>|<span class="string">_some_other_file.yml</span></span><br><span class="line"><span class="string">           </span>|<span class="string">_ ...</span></span><br></pre></td></tr></table></figure></p><p>名为 <code>main.yml</code> 的文件不是强制的。 然而，当它们存在时，role 会自动将它们添加到剧本中。 您可以使用此文件运行包含其他任务、处理程序… 。 我们一会儿就知道了。</p><p>注意，还有一个 <code>vars</code> 和一个 <code>meta</code> 目录。 当你想把一堆关于 role 的变量。 然而，我不喜欢直接在角色中设置 vars。 我认为变量属于配置，而剧本是结构。 换句话说，我将剧本和角色视为工厂，将数据视为工厂的输入。 所以我真的更喜欢有“数据”(例如变量)以外的角色和发挥。 通过这种方式，我可以更容易地分享我的角色，而不用担心过多地暴露我的服务器。 但这只是个人偏好。 让你按照自己想要的方式去做。</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>翻译: ansible-tuto（10-11) </title>
    <link href="http://yoursite.com/2020/05/17/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8810-11%EF%BC%89/"/>
    <id>http://yoursite.com/2020/05/17/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8810-11%EF%BC%89/</id>
    <published>2020-05-17T02:08:12.000Z</published>
    <updated>2020-05-17T04:33:46.958Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="step-10-模板"><a href="#step-10-模板" class="headerlink" title="step-10 模板"></a>step-10 模板</h1><p>我们将使用 <code>haproxy</code> 作为负载平衡器。 当然，安装就像我们对 apache 所做的一样。 但是现在的配置有点复杂，因为我们需要在 haproxy 的配置中列出所有的 web 服务器。 我们怎么才能做到呢？</p><h3 id="HAProxy-配置template（模板"><a href="#HAProxy-配置template（模板" class="headerlink" title="HAProxy 配置template（模板)"></a>HAProxy 配置template（模板)</h3><p>Ansible 使用了 <a href="https://jinja.palletsprojects.com/en/2.11.x/" target="_blank" rel="noopener">Jinja2</a>, Python 的 一个模板引擎。 当您编写 Jinja2模板时，您可以使用 Ansible 定义的任何变量。</p><p>例如，如果您想输出模板当前生成的主机的库存名称，只需在 <code>jinja</code> 模板中写入 `&#123; inventory hostname &#125; </p><p>或者如果你需要第一个以太网接口的 IP 地址(多亏了 <code>setup</code> 模块，所以ansible 才知道) ，你只需要写:  &#123;&#123; ansible_default_ipv4.address &#125;&#125; (相当于  &#123;&#123; ansible_default_ipv4[‘address’] &#125;&#125; )</p><p>Jinja2模板还支持条件、 for-loop 等。</p><p>让我们创建一个 <code>templates/</code> 目录并在其中创建一个 jinja 模板。 我们称之为<code>haproxy.cfg.j2</code>。 我们使用 <code>.j2</code> 扩展名，以显示这是一个 Jinja2模板，但这是不必要的。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    daemon</span><br><span class="line">    maxconn <span class="number">256</span></span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode http</span><br><span class="line">    timeout connect <span class="number">5000</span>ms</span><br><span class="line">    timeout client <span class="number">50000</span>ms</span><br><span class="line">    timeout server <span class="number">50000</span>ms</span><br><span class="line"></span><br><span class="line">listen cluster</span><br><span class="line">    bind  &amp;#<span class="number">123</span>; &amp;#<span class="number">123</span>; ansible_host &amp;#<span class="number">125</span>;&amp;#<span class="number">125</span>;<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    stats enable</span><br><span class="line">    balance roundrobin</span><br><span class="line"></span><br><span class="line">&amp;#<span class="number">123</span>;% <span class="keyword">for</span> backend <span class="keyword">in</span> groups[<span class="string">'web'</span>] %&amp;#<span class="number">125</span>;    server  &amp;#<span class="number">123</span>;&amp;#<span class="number">123</span>; hostvars[backend][<span class="string">'ansible_hostname'</span>] &amp;#<span class="number">125</span>;&amp;#<span class="number">125</span>; &amp;#<span class="number">123</span>;&amp;#<span class="number">123</span>; hostvars[backend].ansible_host &amp;#<span class="number">125</span>;&amp;#<span class="number">125</span>;check port <span class="number">80</span></span><br><span class="line">&amp;#<span class="number">123</span>;% endfor %&amp;#<span class="number">125</span>;    option httpchk HEAD /index.php HTTP/<span class="number">1.0</span></span><br></pre></td></tr></table></figure><ul><li>PS： 以上的<code>&amp;#123;</code>为<code>{</code>,<code>&amp;#125;</code>为<code>}</code>，均为markdown语法，这是因为 “&#123;&#123;  &#125;&#125;” 为当前博客模板所使用到的语法，不转义会发生错误</li></ul><p>我们这里有很多新奇事物</p><p>首先，” &#123;&#123; ansible host &#125;&#125;” 将被服务器的第二个 IP 替换，这个 IP 恰好是192.168.33.10。</p><p>然后，我们有一个循环。 此循环用于构建后端服务器列表。 它将循环遍历 <code>[web]组</code> 中列出的每个主机(并将此主机放入后端变量中)。 对于每个主机，它将使用主机的<code>facts</code> 呈现一行。 所有主机的 <code>facts</code> 都在 <code>hostvars</code> 变量中被设置，因此很容易访问其他主机变量(比如它的主机名或在本例中的 IP)。</p><p>我们可以用手写主机列表，因为我们只有两个主机。 但是我们希望这个服务器集群规模能够非常大，我们需要一百个这样的服务器。 因此，向配置中添加服务器或者交换一些服务器可以归结为从 <code>[web]</code> 组中添加或删除主机。</p><h3 id="Haproxy-的剧本"><a href="#Haproxy-的剧本" class="headerlink" title="Haproxy 的剧本"></a>Haproxy 的剧本</h3><p>我们已经完成了这项工作中最困难的部分，编写一个安装和配置 HAproxy 的剧本是一件轻而易举的事情:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Installs</span> <span class="string">haproxy</span> <span class="string">load</span> <span class="string">balancer</span></span><br><span class="line"><span class="attr">      apt:</span></span><br><span class="line"><span class="attr">        pkg:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">        update_cache:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Pushes</span> <span class="string">configuration</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        src:</span> <span class="string">templates/haproxy.cfg.j2</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="number">0640</span></span><br><span class="line"><span class="attr">        owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      notify:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">restart</span> <span class="string">haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Sets</span> <span class="string">default</span> <span class="string">starting</span> <span class="string">flag</span> <span class="string">to</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      lineinfile:</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/etc/default/haproxy</span></span><br><span class="line"><span class="attr">        regexp:</span> <span class="string">"^ENABLED"</span></span><br><span class="line"><span class="attr">        line:</span> <span class="string">"ENABLED=1"</span></span><br><span class="line"><span class="attr">      notify:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">restart</span> <span class="string">haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">      service:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure><p>看起来很眼熟，是吧？ 这里唯一的新模块是 <code>template</code>，它具有与 <code>copy</code> 相同的参数。 我们还将这个剧本限制在 <code>group haproxy</code></p><p>现在… 让我们试试这个。 因为我们的库存只包含集群所需的主机，所以我们不需要限制主机列表，甚至可以同时运行两个剧本。 好吧，说实话，我们必须同时运行这两个服务器，因为 haproxy playbook 需要两个 web 服务器提供 <code>facts</code> 在步骤11中，我们将展示如何避免这种情况。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i step-10/hosts step-10/apache.yml step-10/haproxy.yml</span><br><span class="line"></span><br><span class="line">PLAY [web] *********************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS *********************</span><br><span class="line">ok: [host1]</span><br><span class="line">ok: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Updates apt cache] *********************</span><br><span class="line">ok: [host1]</span><br><span class="line">ok: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Installs necessary packages] *********************</span><br><span class="line">ok: [host1] =&gt; (<span class="attribute">item</span>=apache2,libapache2-mod-php,git)</span><br><span class="line">ok: [host2] =&gt; (<span class="attribute">item</span>=apache2,libapache2-mod-php,git)</span><br><span class="line"></span><br><span class="line">TASK: [Push future<span class="built_in"> default </span>virtual host configuration] *********************</span><br><span class="line">ok: [host2]</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Activates our virtualhost] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line">changed: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Check that our<span class="built_in"> config </span>is valid] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line">changed: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Restoring old<span class="built_in"> default </span>virtualhost] *********************</span><br><span class="line">skipping: [host1]</span><br><span class="line">skipping: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Removing out virtualhost] *********************</span><br><span class="line">skipping: [host1]</span><br><span class="line">skipping: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Ending playbook] *********************</span><br><span class="line">skipping: [host1]</span><br><span class="line">skipping: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Deploy our awesome application] *********************</span><br><span class="line">ok: [host2]</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Deactivates the<span class="built_in"> default </span>virtualhost] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line">changed: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Deactivates the<span class="built_in"> default </span>ssl virtualhost] *********************</span><br><span class="line">changed: [host2]</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">NOTIFIED: [restart apache] *********************</span><br><span class="line">changed: [host2]</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************</span><br><span class="line">host1              : <span class="attribute">ok</span>=10   <span class="attribute">changed</span>=5    <span class="attribute">unreachable</span>=0    <span class="attribute">failed</span>=0</span><br><span class="line">host2              : <span class="attribute">ok</span>=10   <span class="attribute">changed</span>=5    <span class="attribute">unreachable</span>=0    <span class="attribute">failed</span>=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PLAY [haproxy] *********************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS *********************</span><br><span class="line">ok: [host0]</span><br><span class="line"></span><br><span class="line">TASK: [Installs haproxy load balancer] *********************</span><br><span class="line">changed: [host0]</span><br><span class="line"></span><br><span class="line">TASK: [Pushes configuration] *********************</span><br><span class="line">changed: [host0]</span><br><span class="line"></span><br><span class="line">TASK: [Sets<span class="built_in"> default </span>starting flag <span class="keyword">to</span> 1] *********************</span><br><span class="line">changed: [host0]</span><br><span class="line"></span><br><span class="line">NOTIFIED: [restart haproxy] *********************</span><br><span class="line">changed: [host0]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************</span><br><span class="line">host0              : <span class="attribute">ok</span>=5    <span class="attribute">changed</span>=4    <span class="attribute">unreachable</span>=0    <span class="attribute">failed</span>=0</span><br></pre></td></tr></table></figure><p>看起来不错，现在去 <a href="http://192.168.33.10/" target="_blank" rel="noopener">http://192.168.33.10/</a> 看看结果，你的集群已经部署好了！</p><p>你甚至可以在 <a href="http://192.168.33.10/HAProxy?stats" target="_blank" rel="noopener">http://192.168.33.10/HAProxy?stats</a> 看到 HAProxy 的统计数据</p><p>现在进入 <code>step-11</code> 中关于“变量”的下一章。</p><h1 id="step-11-再次探索变量"><a href="#step-11-再次探索变量" class="headerlink" title="step-11 再次探索变量"></a>step-11 再次探索变量</h1><p>因此，我们已经设置了负载均衡器，它工作得非常好。 我们从 <code>facts</code> 中获取变量并使用它们来构建配置。 但是 Ansible 也支持其他类型的变量。 我们已经在库存中见过了 <code>ansible_host</code> ，但是现在我们将使用定义在在 <code>host_vars</code> 和 <code>group_vars</code> 文件中的变量。</p><h3 id="微调我们的-HAProxy-配置"><a href="#微调我们的-HAProxy-配置" class="headerlink" title="微调我们的 HAProxy 配置"></a>微调我们的 HAProxy 配置</h3><p>Haproxy 通常检查后端是否是活动的。 当一个后端看起来死了，它就会从后端池中删除，且 HAproxy 不再向它发送请求。</p><p>后端还可以有不同的权重(在0到256之间)。 权重越高，与其他后端相比，后端将接收的连接数量越多。 如果节点的能力不够强大，那么更好地传播流量是很有用的。</p><p>我们将使用变量来配置所有这些参数。</p><h3 id="Group-vars"><a href="#Group-vars" class="headerlink" title="Group vars"></a>Group vars</h3><p>Check interval 将在 haproxy 的 <code>group_vars</code> 文件中设置。 这将确保所有的 <code>haproxy</code> 将继承它。</p><p>我们只需要在库存目录下创建文件 <code>groups_vars/haproxy.yml</code>。 文件必须要以为其定义变量的组命名。 如果我们想为 web 组定义变量，那么这个文件应该命名为 <code>group _vars/web.xml</code></p><p><strong>请注意</strong>。 <code>.yml</code> 是可选的: 我们可以将 haproxy 的组变量文件命名为 <code>groups_vars/haproxy</code> 。这个扩展名只是帮助编辑器选择正确的语法使其高亮。</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">haproxy_check_interval:</span> <span class="number">3000</span></span><br><span class="line"><span class="symbol">haproxy_stats_socket:</span> <span class="meta-keyword">/tmp/</span>sock</span><br></pre></td></tr></table></figure><p>这个名字是随意的。 当然，建议使用有意义的名称，这里没有什么必要的语法。 你甚至可以像这样使用 <code>complex variables</code>(也就是 Python dict) :</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">haproxy:</span></span><br><span class="line"><span class="symbol">    check_interval:</span> <span class="number">3000</span></span><br><span class="line"><span class="symbol">    stats_socket:</span> <span class="meta-keyword">/tmp/</span>sock</span><br></pre></td></tr></table></figure><p>这只是品味问题。 <code>complex variables</code> 可以更加有逻辑地分组东西。 在某些情况下，它们还可以合并随后定义的键(但是请注意，这不是默认的可合并行为)。 现在我们只使用简单的变量。</p><h3 id="Hosts-vars"><a href="#Hosts-vars" class="headerlink" title="Hosts vars"></a>Hosts vars</h3><p><code>Hosts vars</code> 遵循完全相同的规则，但是文件存储在 <code>host_vars</code> 目录下</p><p>让我们在 <code>hosts_vars/host1.example.com</code> 中定义后端的权重:<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">haproxy_backend_weight: <span class="number">100</span></span><br></pre></td></tr></table></figure></p><p>以及 <code>host_vars/host2.example.com</code>:<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">haproxy_backend_weight: <span class="number">150</span></span><br></pre></td></tr></table></figure></p><p>如果我们在 <code>group_vars/web</code> 中定义 haproxy 后端权重，它将被用作“缺省” : 在 <code>host_vars</code> 文件中定义的变量将覆盖 <code>group_vars</code> 中定义的变量。</p><h3 id="更新模板"><a href="#更新模板" class="headerlink" title="更新模板"></a>更新模板</h3><p>必须更新模板以使用这些变量。<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    daemon</span><br><span class="line">    maxconn <span class="number">256</span></span><br><span class="line">&amp;#<span class="number">123</span>;% <span class="keyword">if</span> haproxy_stats_socket %&amp;#<span class="number">125</span>;    stats socket  &amp;#<span class="number">123</span>; &amp;#<span class="number">123</span>; haproxy_stats_socket &amp;#<span class="number">125</span>;&amp;#<span class="number">125</span>;&amp;#<span class="number">123</span>;% endif %&amp;#<span class="number">125</span>;</span><br><span class="line">defaults</span><br><span class="line">    mode http</span><br><span class="line">    timeout connect <span class="number">5000</span>ms</span><br><span class="line">    timeout client <span class="number">50000</span>ms</span><br><span class="line">    timeout server <span class="number">50000</span>ms</span><br><span class="line"></span><br><span class="line">listen cluster</span><br><span class="line">    bind  &amp;#<span class="number">123</span>; &amp;#<span class="number">123</span>; ansible_all_ipv4_addresses<span class="number">.1</span> &amp;#<span class="number">125</span>;&amp;#<span class="number">125</span>;<span class="number">80</span></span><br><span class="line">    mode http</span><br><span class="line">    stats enable</span><br><span class="line">    balance roundrobin</span><br><span class="line">&amp;#<span class="number">123</span>;% <span class="keyword">for</span> backend <span class="keyword">in</span> groups[<span class="string">'web'</span>] %&amp;#<span class="number">125</span>;    server  &amp;#<span class="number">123</span>; &amp;#<span class="number">123</span>; hostvars[backend][<span class="string">'ansible_hostname'</span>] &amp;#<span class="number">125</span>;&amp;#<span class="number">125</span>; &amp;#<span class="number">123</span>; &amp;#<span class="number">123</span>; hostvars[backend].ansible_all_ipv4_addresses<span class="number">.1</span> &amp;#<span class="number">125</span>;&amp;#<span class="number">125</span>;check port <span class="number">80</span></span><br><span class="line">&amp;#<span class="number">123</span>;% endfor %&amp;#<span class="number">125</span>;    option httpchk HEAD /index.php HTTP/<span class="number">1.0</span></span><br></pre></td></tr></table></figure></p><p><strong>注意</strong>，我们还引入了<code>&amp;#123;% if...</code> 。 只有在测试为真时，才会使用这个封闭的块。 因此，如果我们在某个地方为负载均衡器定义了 <code>haproxy_stats_socket</code> (我们甚至可以在命令行中使用 <code>--extra-vars“ haproxy_stats_sockets /tmp/sock”</code>) ，那么封闭其中的配置行将出现在生成的配置文件中(注意，建议的设置非常不安全!) </p><p>让我们试试看</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i step<span class="number">-11</span>/hosts step<span class="number">-11</span>/haproxy.yml</span><br></pre></td></tr></table></figure><p>请注意，虽然我们可以，但是没有必要运行 apache 的剧本，因为什么都没有改变，但是我们不得不为此作弊。 以下是最新的 haproxy 剧本:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Installs</span> <span class="string">haproxy</span> <span class="string">load</span> <span class="string">balancer</span></span><br><span class="line"><span class="attr">      apt:</span></span><br><span class="line"><span class="attr">        pkg:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">        update_cache:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Pushes</span> <span class="string">configuration</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        src:</span> <span class="string">templates/haproxy.cfg.j2</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="number">0640</span></span><br><span class="line"><span class="attr">        owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">        group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      notify:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">restart</span> <span class="string">haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Sets</span> <span class="string">default</span> <span class="string">starting</span> <span class="string">flag</span> <span class="string">to</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      lineinfile:</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/etc/default/haproxy</span></span><br><span class="line"><span class="attr">        regexp:</span> <span class="string">"^ENABLED"</span></span><br><span class="line"><span class="attr">        line:</span> <span class="string">"ENABLED=1"</span></span><br><span class="line"><span class="attr">      notify:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">restart</span> <span class="string">haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">      service:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">haproxy</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure></p><p>看到了吗？ 我们在顶部为 web 主机添加了一个空的剧本。 它除了收集 <code>facts</code> 以外什么也不做。 但是它必须在这里，因为它将触发 <code>facts</code> 收集在主机上的群组网络。 这是必要的，因为 haproxy playbook 需要从这个组的主机中选择 <code>facts</code> 。 如果我们不这样做，ansible 可能会抱怨说 <code>ansible_all_ipv4_addresses</code>都不存在</p><p>请注意，我们已经在前面的步骤中提到了这一点，但是我们没有提到它。</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>翻译: ansible-tuto（08-09）</title>
    <link href="http://yoursite.com/2020/05/16/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8808-09%EF%BC%89/"/>
    <id>http://yoursite.com/2020/05/16/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8808-09%EF%BC%89/</id>
    <published>2020-05-16T02:26:11.000Z</published>
    <updated>2020-05-16T09:33:52.590Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="step08-从-git-部署我们的网站"><a href="#step08-从-git-部署我们的网站" class="headerlink" title="step08 从 git 部署我们的网站"></a>step08 从 git 部署我们的网站</h1><p>我们已经安装了 apache，设置了虚拟主机，并安全地重新启动了服务器。 现在我们将使用 git 模块来部署我们的应用程序。</p><h3 id="Git-模块"><a href="#Git-模块" class="headerlink" title="Git 模块"></a>Git 模块</h3><p>这是一个小放松，没有什么新的东西。<code>git</code> 模块只是另一个模块。 尽管我们只是为了好玩而尝试。当它涉及 <code>ansible-pull</code>以后，我们将更加熟悉它，</p><p>我们的虚拟机已经设置好了，但是我们需要一些更改来完成部署。 首先，我们正在部署一个 PHP 应用程序。 因此，我们需要安装 <code>libapache2-mod-php</code> 包。 其次，我们必须安装 git，因为 <code>git</code> 模块(用于克隆我们应用程序的 git 存储库)将使用它。</p><p>我们可以这样做:<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">- name: Installs apache web server</span><br><span class="line">  apt:</span><br><span class="line">    pkg: apache2</span><br><span class="line">    <span class="keyword">state</span>: present</span><br><span class="line">    update_cache: true</span><br><span class="line"></span><br><span class="line">- name: Installs php module</span><br><span class="line">  apt:</span><br><span class="line">    pkg: libapache2-mod-php</span><br><span class="line">    <span class="keyword">state</span>: present</span><br><span class="line"></span><br><span class="line">- name: Installs git</span><br><span class="line">  apt:</span><br><span class="line">    pkg: git</span><br><span class="line">    <span class="keyword">state</span>: present</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>但是 ansible 提供了一种更易读的编写方式。 Ansible 可以在一系列 <code>items</code> 上循环遍历，并在一个动作中使用每个 <code>item</code> :<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Installs</span> <span class="string">necessary</span> <span class="string">packages</span></span><br><span class="line"><span class="attr">      apt:</span></span><br><span class="line"><span class="attr">        pkg:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">        update_cache:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      with_items:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">apache2</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">libapache2-mod-php</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">git</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Push</span> <span class="string">future</span> <span class="string">default</span> <span class="string">virtual</span> <span class="string">host</span> <span class="string">configuration</span></span><br><span class="line"><span class="attr">      copy:</span></span><br><span class="line"><span class="attr">        src:</span> <span class="string">files/awesome-app</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/etc/apache2/sites-available/</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="number">0640</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Activates</span> <span class="string">our</span> <span class="string">virtualhost</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">a2ensite</span> <span class="string">awesome-app</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Check</span> <span class="string">that</span> <span class="string">our</span> <span class="string">config</span> <span class="string">is</span> <span class="string">valid</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">apache2ctl</span> <span class="string">configtest</span></span><br><span class="line"><span class="attr">      register:</span> <span class="string">result</span></span><br><span class="line"><span class="attr">      ignore_errors:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Rolling</span> <span class="string">back</span> <span class="bullet">-</span> <span class="string">Restoring</span> <span class="string">old</span> <span class="string">default</span> <span class="string">virtualhost</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">a2ensite</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">result</span> <span class="string">is</span> <span class="string">failed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Rolling</span> <span class="string">back</span> <span class="bullet">-</span> <span class="string">Removing</span> <span class="string">out</span> <span class="string">virtualhost</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">a2dissite</span> <span class="string">awesome-app</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">result</span> <span class="string">is</span> <span class="string">failed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Rolling</span> <span class="string">back</span> <span class="bullet">-</span> <span class="string">Ending</span> <span class="string">playbook</span></span><br><span class="line"><span class="attr">      fail:</span></span><br><span class="line"><span class="attr">        msg:</span> <span class="string">"Configuration file is not valid. Please check that before re-running the playbook."</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">result</span> <span class="string">is</span> <span class="string">failed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Deploy</span> <span class="string">our</span> <span class="string">awesome</span> <span class="string">application</span></span><br><span class="line"><span class="attr">      git:</span></span><br><span class="line"><span class="attr">        repo:</span> <span class="attr">https://github.com/leucos/ansible-tuto-demosite.git</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/var/www/awesome-app</span></span><br><span class="line"><span class="attr">      tags:</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Deactivates</span> <span class="string">the</span> <span class="string">default</span> <span class="string">virtualhost</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">a2dissite</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">Deactivates</span> <span class="string">the</span> <span class="string">default</span> <span class="string">ssl</span> <span class="string">virtualhost</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">a2dissite</span> <span class="string">default-ssl</span></span><br><span class="line"><span class="attr">      notify:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">apache2</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure></p><p>接下来开始吧：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i step-08/hosts -l host1 step-08/apache.yml</span><br><span class="line"></span><br><span class="line">PLAY [web] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line"></span><br><span class="line">GATHERING FACTS <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Updates apt cache] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Installs necessary packages] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1] =&gt; (item=apache2,libapache2-mod-php,git)</span><br><span class="line"></span><br><span class="line">TASK: [Push future default virtual host configuration] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Activates our virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Check that our config is valid] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Restoring old default virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">skipping: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Removing out virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">skipping: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Ending playbook] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">skipping: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Deploy our awesome application] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Deactivates the default virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Deactivates the default ssl virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">NOTIFIED: [restart apache] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">host1              : ok=10   changed=8    unreachable=0    failed=0</span><br></pre></td></tr></table></figure></p><p>你现在可以浏览 <a href="http://192.168.33.11，它应该会显示一张图片和服务器的主机名。" target="_blank" rel="noopener">http://192.168.33.11，它应该会显示一张图片和服务器的主机名。</a></p><p><strong>注意</strong> <code>tags: deploy</code>  这一行允许您只执行 playbook 的一部分。 比如说你为你的网站推出了一个新版本。 您希望加快处理速度，只执行处理 <code>deploy</code> 的部分。 标签允许你这样做。 当然，<code>deploy</code> 只是一个字符串，它没有任何特定的含义，可以是任何东西。 让我们来看看如何使用它:</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i step-08/hosts -l host1 step-08/apache.yml -t deploy</span><br><span class="line">X11 forwarding request failed on channel 0</span><br><span class="line"></span><br><span class="line">PLAY [web] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line"></span><br><span class="line">GATHERING FACTS <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Deploy our awesome application] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">host1              : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><p>让我们在 <code>step-09</code> 中部署另一个 web 服务器。</p><h1 id="step-09-添加另外一个-webserver"><a href="#step-09-添加另外一个-webserver" class="headerlink" title="step-09 添加另外一个 webserver"></a>step-09 添加另外一个 webserver</h1><p>我们已经有了一个 webserver，让我们添加另外一个</p><h3 id="更新库存文件"><a href="#更新库存文件" class="headerlink" title="更新库存文件"></a>更新库存文件</h3><p>由于我们对此抱有有很大的期望，我们将添加另一个 web 服务器和一个负载均衡器，我们将在下一步配置它。让我们完成它。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[web]</span><br><span class="line">host1 <span class="attribute">ansible_host</span>=192.168.33.11 <span class="attribute">ansible_user</span>=root</span><br><span class="line">host2 <span class="attribute">ansible_host</span>=192.168.33.12 <span class="attribute">ansible_user</span>=root</span><br><span class="line"></span><br><span class="line">[haproxy]</span><br><span class="line">host0 <span class="attribute">ansible_host</span>=192.168.33.10 <span class="attribute">ansible_user</span>=root</span><br></pre></td></tr></table></figure><p>请记住，<code>ansible_host</code> 在这里指定可接受的主机，因为主机的 IP 与预期的不同(或者无法解析)。 您可以将这些主机添加到您的 <code>/etc/hosts</code> 中，而不必担心，或者使用真正的主机名(这是典型情况下应该做的)。</p><h3 id="部署另一个-webserver"><a href="#部署另一个-webserver" class="headerlink" title="部署另一个 webserver"></a>部署另一个 webserver</h3><p>部署另一个 webserver 很简单</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i step-09/hosts step-09/apache.yml</span><br><span class="line"></span><br><span class="line">PLAY [web] *********************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS *********************</span><br><span class="line">ok: [host2]</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Updates apt cache] *********************</span><br><span class="line">ok: [host1]</span><br><span class="line">ok: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Installs necessary packages] *********************</span><br><span class="line">ok: [host1] =&gt; (<span class="attribute">item</span>=apache2,libapache2-mod-php,git)</span><br><span class="line">changed: [host2] =&gt; (<span class="attribute">item</span>=apache2,libapache2-mod-php,git)</span><br><span class="line"></span><br><span class="line">TASK: [Push future<span class="built_in"> default </span>virtual host configuration] *********************</span><br><span class="line">ok: [host1]</span><br><span class="line">changed: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Activates our virtualhost] *********************</span><br><span class="line">changed: [host2]</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Check that our<span class="built_in"> config </span>is valid] *********************</span><br><span class="line">changed: [host2]</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Restoring old<span class="built_in"> default </span>virtualhost] *********************</span><br><span class="line">skipping: [host1]</span><br><span class="line">skipping: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Removing out virtualhost] *********************</span><br><span class="line">skipping: [host1]</span><br><span class="line">skipping: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Ending playbook] *********************</span><br><span class="line">skipping: [host1]</span><br><span class="line">skipping: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Deploy our awesome application] *********************</span><br><span class="line">ok: [host1]</span><br><span class="line">changed: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Deactivates the<span class="built_in"> default </span>virtualhost] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line">changed: [host2]</span><br><span class="line"></span><br><span class="line">TASK: [Deactivates the<span class="built_in"> default </span>ssl virtualhost] *********************</span><br><span class="line">changed: [host2]</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">NOTIFIED: [restart apache] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line">changed: [host2]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************</span><br><span class="line">host1              : <span class="attribute">ok</span>=10   <span class="attribute">changed</span>=5    <span class="attribute">unreachable</span>=0    <span class="attribute">failed</span>=0</span><br><span class="line">host2              : <span class="attribute">ok</span>=10   <span class="attribute">changed</span>=8    <span class="attribute">unreachable</span>=0    <span class="attribute">failed</span>=0</span><br></pre></td></tr></table></figure><p>我们所要做的就是从命令行中移除 <code>-l host1</code>。 记住 <code>-l</code> 是一个参数，它限制了 playbook 在特定主机上运行。 现在我们不再限制，它将运行在所有的主机上，在这些主机上的剧本打算运行(即 web组)。</p><p>如果我们在 group <code>web</code> 中有其他服务器，但是希望将 playbook 限制为一个子集，我们可以使用，例如:<code>-l firstthost: secondhost:...</code></p><p>现在我们已经有了这个不错的 web 服务器组，让我们通过在 <code>step-10</code> 中在它们前面放置一个负载均衡器，将它变成为一个集群。</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>翻译: ansible-tuto（06-07）</title>
    <link href="http://yoursite.com/2020/05/15/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8806-07%EF%BC%89/"/>
    <id>http://yoursite.com/2020/05/15/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8806-07%EF%BC%89/</id>
    <published>2020-05-15T12:30:46.000Z</published>
    <updated>2020-05-15T13:32:49.731Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="step-06-当配置正确时重新启动"><a href="#step-06-当配置正确时重新启动" class="headerlink" title="step-06 当配置正确时重新启动"></a>step-06 当配置正确时重新启动</h1><p>我们已经安装了 apache，配置了虚拟主机，并重新启动了服务器。 但是，如果我们只是希望在配置正确的情况下重新启动服务器，那又会怎样呢？ 让我们开始吧</p><h3 id="当出现问题的时候停止工作"><a href="#当出现问题的时候停止工作" class="headerlink" title="当出现问题的时候停止工作"></a>当出现问题的时候停止工作</h3><p>ansible 有一个俏皮的特性: 如果出现问题，它将停止所有的工作。 如果配置文件无效的话，我们将利用这个特性来停止我们的 playbook。</p><p>让我们修改一下我们的 <code>awesome-app</code> 虚拟主机配置文件:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">  RocumentDoot /<span class="keyword">var</span>/www/awesome-<span class="keyword">app</span></span><br><span class="line"></span><br><span class="line">  Options -Indexes</span><br><span class="line"></span><br><span class="line">  ErrorLog /<span class="keyword">var</span>/<span class="keyword">log</span>/apache2/<span class="keyword">error</span>.<span class="built_in">log</span></span><br><span class="line">  TransferLog /<span class="keyword">var</span>/<span class="keyword">log</span>/apache2/access.<span class="built_in">log</span></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure></p><p>如前所述，当任务失败时，处理过程停止。 因此，在重新启动服务器之前，我们将确保配置有效。 我们还可以在删除缺省的虚拟主机之前添加虚拟主机，这样随后的重新启动(可能直接在服务器上完成)就不会破坏 apache。</p><p>请注意，我们一开始就应该这样做。 因为我们已经运行了我们的剧本，默认的虚拟主机已经被停用了。 当然，其他无关的主机也可以使用这个剧本，让我们保护他们。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installs apache web server</span><br><span class="line">      apt:</span><br><span class="line">        pkg: apache2</span><br><span class="line">        state: present</span><br><span class="line">        update_cache: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    - name: Push future<span class="built_in"> default </span>virtual host configuration</span><br><span class="line">      copy:</span><br><span class="line">        src: files/awesome-app</span><br><span class="line">        dest: /etc/apache2/sites-available/</span><br><span class="line">        mode: 0640</span><br><span class="line"></span><br><span class="line">    - name: Activates our virtualhost</span><br><span class="line">      command: a2ensite awesome-app</span><br><span class="line"></span><br><span class="line">    - name: Check that our<span class="built_in"> config </span>is valid</span><br><span class="line">      command: apache2ctl configtest</span><br><span class="line"></span><br><span class="line">    - name: Deactivates the<span class="built_in"> default </span>virtualhost</span><br><span class="line">      command: a2dissite default</span><br><span class="line"></span><br><span class="line">    - name: Deactivates the<span class="built_in"> default </span>ssl virtualhost</span><br><span class="line">      command: a2dissite default-ssl</span><br><span class="line">      notify:</span><br><span class="line">        - restart apache</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart apache</span><br><span class="line">      service:</span><br><span class="line">        name: apache2</span><br><span class="line">        state: restarted</span><br></pre></td></tr></table></figure><p>接下来开始吧：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PLAY [web] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line"></span><br><span class="line">GATHERING FACTS <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Installs apache web server] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Push future default virtual host configuration] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Activates our virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Check that our config is valid] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">failed: [host1] =&gt; &#123;"changed": true, "cmd": ["apache2ctl", "configtest"], "delta": "0:00:00.045046", "end": "2013-03-08 16:09:32.002063", "rc": 1, "start": "2013-03-08 16:09:31.957017"&#125;</span><br><span class="line">stderr: Syntax error on line 2 of /etc/apache2/sites-enabled/awesome-app:</span><br><span class="line">Invalid command 'RocumentDoot', perhaps misspelled or defined by a module not included in the server configuration</span><br><span class="line">stdout: Action 'configtest' failed.</span><br><span class="line">The Apache error log may have more information.</span><br><span class="line"></span><br><span class="line">FATAL: all hosts have already failed -- aborting</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">host1              : ok=4    changed=2    unreachable=0    failed=1</span><br></pre></td></tr></table></figure></p><p>正如您可以看到的，因为 apache2ctl 在失败时返回退出代码为1，ansible 发现了这一点并停止了处理。 太好了！</p><p>嗯，实际上不是很好… 我们的虚拟主机已经添加了。 任何后续的 apache 重新启动都会抱怨我们的配置，然后退出。 因此，我们需要一种方法来发现故障并返回。</p><h1 id="step-07-使用条件语句"><a href="#step-07-使用条件语句" class="headerlink" title="step-07 使用条件语句"></a>step-07 使用条件语句</h1><p>我们已经安装了 apache，设置了虚拟主机，并重新启动了服务器。 但是，我们希望在出现问题时，能够将其恢复到稳定状态。</p><h3 id="当出错时回滚"><a href="#当出错时回滚" class="headerlink" title="当出错时回滚"></a>当出错时回滚</h3><p>提醒一句: 这里没有魔法。 之前配置错误不是 <code>ansible</code> 的错误。 它不是一个备份系统，它不能回滚所有的东西。 你的工作就是确保你的剧本是配置正确的。 ansible 不知道如何恢复一个<code>2ensite awesome-app</code>。</p><p>但是，如果我们关注配置错误时于怎么回滚，那么就可以利用它进行回滚</p><p>如前所述，当任务失败时，处理就会停止… 除非我们接受失败(我们应该接受)。 这就是我们要做的: 如果出现故障，继续处理，但是只恢复我们已经完成的操作。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installs apache web server</span><br><span class="line">      apt:</span><br><span class="line">        pkg: apache2</span><br><span class="line">        state: present</span><br><span class="line">        update_cache: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    - name: Push future<span class="built_in"> default </span>virtual host configuration</span><br><span class="line">      copy:</span><br><span class="line">        src: files/awesome-app</span><br><span class="line">        dest: /etc/apache2/sites-available/</span><br><span class="line">        mode: 0640</span><br><span class="line"></span><br><span class="line">    - name: Activates our virtualhost</span><br><span class="line">      command: a2ensite awesome-app</span><br><span class="line"></span><br><span class="line">    - name: Check that our<span class="built_in"> config </span>is valid</span><br><span class="line">      command: apache2ctl configtest</span><br><span class="line">      register: result</span><br><span class="line">      ignore_errors: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    - name: Rolling back - Restoring old<span class="built_in"> default </span>virtualhost</span><br><span class="line">      command: a2ensite default</span><br><span class="line">      when: result is failed</span><br><span class="line"></span><br><span class="line">    - name: Rolling back - Removing our virtualhost</span><br><span class="line">      command: a2dissite awesome-app</span><br><span class="line">      when: result is failed</span><br><span class="line"></span><br><span class="line">    - name: Rolling back - Ending playbook</span><br><span class="line">      fail:</span><br><span class="line">        msg: <span class="string">"Configuration file is not valid. Please check that before re-running the playbook."</span></span><br><span class="line">      when: result is failed</span><br><span class="line"></span><br><span class="line">    - name: Deactivates the<span class="built_in"> default </span>virtualhost</span><br><span class="line">      command: a2dissite default</span><br><span class="line"></span><br><span class="line">    - name: Deactivates the<span class="built_in"> default </span>ssl virtualhost</span><br><span class="line">      command: a2dissite default-ssl</span><br><span class="line">      notify:</span><br><span class="line">        - restart apache</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart apache</span><br><span class="line">      service:</span><br><span class="line">        name: apache2</span><br><span class="line">        state: restarted</span><br></pre></td></tr></table></figure></p><p><code>register</code> 关键字记录 <code>apache2ctl configtest</code> 命令(exit status、 stdout、 stderr、 …)的输出，以及 <code>when: result is failed</code> 检查注册变量(<code>result</code>)是否失败。</p><p>接下来开始吧：<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i step-07/hosts -l host1 step-07/apache.yml</span><br><span class="line"></span><br><span class="line">PLAY [web] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line"></span><br><span class="line">GATHERING FACTS <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Installs apache web server] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Push future default virtual host configuration] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Activates our virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Check that our config is valid] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">failed: [host1] =&gt; &#123;"changed": true, "cmd": ["apache2ctl", "configtest"], "delta": "0:00:00.051874", "end": "2013-03-10 10:50:17.714105", "rc": 1, "start": "2013-03-10 10:50:17.662231"&#125;</span><br><span class="line">stderr: Syntax error on line 2 of /etc/apache2/sites-enabled/awesome-app:</span><br><span class="line">Invalid command 'RocumentDoot', perhaps misspelled or defined by a module not included in the server configuration</span><br><span class="line">stdout: Action 'configtest' failed.</span><br><span class="line">The Apache error log may have more information.</span><br><span class="line">...ignoring</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Restoring old default virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Removing our virtualhost] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Rolling back - Ending playbook] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">failed: [host1] =&gt; &#123;"failed": true&#125;</span><br><span class="line">msg: Configuration file is not valid. Please check that before re-running the playbook.</span><br><span class="line"></span><br><span class="line">FATAL: all hosts have already failed -- aborting</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">host1              : ok=7    changed=4    unreachable=0    failed=1</span><br></pre></td></tr></table></figure></p><p>看起来正常工作。让我们尝试重新启动 apache，看看它是否真的工作:</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ansible -i step-<span class="number">07</span>/hosts -m service -a 'name=apache2 <span class="keyword">state</span>=restarted' host1</span><br><span class="line"></span><br><span class="line"><span class="keyword">state</span>=restarted' host1</span><br><span class="line">host1 | success &gt;&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: true,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"apache2"</span>,</span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>好了，现在我们的 apache 安全了，不会出现配置错误。</p><p>虽然这看起来需要做很多工作，但其实不然。 请记住，您几乎可以在任何地方使用变量，因此很容易将其作为 apache 的通用模板，并在任何地方使用它来部署虚拟主机。 创建一次剧本，就可在任何地方使用。 我们将在步骤9中完成这项工作，但是现在，让我们在步骤08中使用 git 部署我们的 web 站点。</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>翻译: ansible-tuto（04-05）</title>
    <link href="http://yoursite.com/2020/05/13/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8804-05%EF%BC%89/"/>
    <id>http://yoursite.com/2020/05/13/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8804-05%EF%BC%89/</id>
    <published>2020-05-13T01:13:42.000Z</published>
    <updated>2020-05-13T03:38:40.917Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="step04-Ansible-playbooks"><a href="#step04-Ansible-playbooks" class="headerlink" title="step04 Ansible playbooks"></a>step04 Ansible playbooks</h1><p>Playbook 的概念非常简单: 它只是一系列可接受的命令(tasks) ，就像我们使用 <code>ansible</code> CLI 工具时所使用的那样。 这些任务针对一组特定的主机/组。</p><p>这个步骤所需的文件应该已经神奇地出现(自带有)，甚至不需要输入它们</p><h3 id="Apache-示例-也就是-Ansible-的“-Hello-World-”"><a href="#Apache-示例-也就是-Ansible-的“-Hello-World-”" class="headerlink" title="Apache 示例(也就是 Ansible 的“ Hello World! ”)"></a>Apache 示例(也就是 Ansible 的“ Hello World! ”)</h3><p>我们假设我们有以下库存文件(让我们把它命名为<code>hosts</code>) :<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[web]</span></span><br><span class="line">host1</span><br></pre></td></tr></table></figure></p><p>所有的主机都是基于 debian 的</p><p><strong>注意</strong>: 请记住您可以(在我们的练习中我们这样做)使用 <code>ansible_host</code> 来设置主机的真实 IP。 您还可以更改库存并使用真正的主机名。 在任何情况下，使用一个非关键的机器测试！ 在真正的主机文件中，我们还有<code>ansible_user=root</code> 来处理潜在的不同的ansible 默认配置(ansible.cfg的默认用户为root,但可能被修改过)</p><p>让我们构建一个将在 <code>web</code> 组中的机器上安装 apache 的剧本。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installs apache web server</span><br><span class="line">      apt:</span><br><span class="line">        pkg: apache2</span><br><span class="line">        state: present</span><br><span class="line">        update_cache: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>我们只需要使用 <code>apt</code> 模块正确说出我们想要做什么。 这里，我们使用 <a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html" target="_blank" rel="noopener">apt</a> 模块来安装 debian 软件包。 我们还要求此模块更新包缓存。</p><p>我们还为这个任务添加了一个名称。 虽然这是不必要的，但是在剧本运行时它提供了很多信息，所以强烈推荐使用。</p><p>总而言之，这是相当容易的！</p><p>您现在可以运行 playbook (让我们称之为 <code>apache.yml</code>) :<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i step<span class="number">-04</span>/hosts -l host1 step<span class="number">-04</span>/apache.yml</span><br></pre></td></tr></table></figure></p><p>在这里，<code>step-04/hosts</code> 是库存文件,<code>-l</code> 将限制只在主机 <code>host1</code>上运行，<code>apache.yml</code> 是我们的剧本。</p><p>当你运行上面的命令时，你应该会看到这样的东西:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PLAY [web] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line"></span><br><span class="line">GATHERING FACTS <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Installs apache web server] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">host1              : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure></p><p>让我们分析一次一行的输出<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PLAY [web] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br></pre></td></tr></table></figure></p><p>告诉我们它正在主机<code>web</code>上运行。 <code>playbook</code>是一套与<code>hosts</code>有关的可接受的指令。 如果我们有另一个<code>- host: blah</code>: 在我们的剧本中，它也会运行(但是只会在第一个剧本结束之后，一个剧本文件可以有包含多个剧本)</p><p>还记得我们使用 <code>setup</code> 模块的时候吗？ 每次运行之前，ansible 都在指定的主机上运行它，以收集事实。 如果因为不需要主机提供任何信息而不需要这样做，那么您可以添加 <code>gather_facts: no</code> 语段在主机条目的下面(与 <code>tasks:</code>相同缩进长度)。</p><p>接下来，是真正的任务: 我们的(第一个也是唯一的)任务正在运行，因为它表示<code>changed</code>，所以我们知道它改变了 host1上的某些内容。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAY RECAP *********************</span><br><span class="line">host1              : <span class="attribute">ok</span>=2    <span class="attribute">changed</span>=1    <span class="attribute">unreachable</span>=0    <span class="attribute">failed</span>=0</span><br></pre></td></tr></table></figure><p>最后，ansible 输出发生了什么: 两个任务已经运行，其中一个在主机上改变了一些东西(我们的 apache 任务，setup 模块没有改变任何东西)。</p><p>现在让我们再运行一次，看看会发生什么:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i step-04/hosts -l host1 step-04/apache.yml</span><br><span class="line"></span><br><span class="line">PLAY [web] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line"></span><br><span class="line">GATHERING FACTS <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Installs apache web server] <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span><br><span class="line">host1              : ok=2    changed=0    unreachable=0    failed=0</span><br></pre></td></tr></table></figure></p><p>现在‘ changed’是‘0’。 这是绝对正常的，也是 <code>ansible</code> 的核心特征之一: 只有在有事情可做的时候，剧本才会采取行动。这就是所谓的幂等性，也就是说你可以随心所欲地运行你的剧本，你最终总是会处于相同的状态(当然，除非你用 shell 模块做了一些疯狂的事情，但这超出了 ansible 的控制范围)</p><h3 id="完善剧本"><a href="#完善剧本" class="headerlink" title="完善剧本"></a>完善剧本</h3><p>当然，我们的剧本可以安装 apache 服务器，但它可以更完整一点。它可以添加一个虚拟主机，确保重新启动 apache。它甚至可以从 git 仓库部署我们的网站</p><h1 id="step-05-完善-apache-设置"><a href="#step-05-完善-apache-设置" class="headerlink" title="step-05 完善 apache 设置"></a>step-05 完善 apache 设置</h1><p>我们已经安装了 apache，现在让我们设置虚拟主机。</p><h3 id="完善剧本-1"><a href="#完善剧本-1" class="headerlink" title="完善剧本"></a>完善剧本</h3><p>我们的服务器上只需要一个虚拟主机，但我们希望用更具体的东西替换默认主机。因此，我们必须移除当前(可能是默认的)虚拟主机，发送至虚拟机，激活它并重新启动 apache。</p><p>让我们创建一个名为 <code>files</code> 的目录，并为 host1添加虚拟主机配置，我们称之为 <code>awesome-app</code>:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">  DocumentRoot /<span class="keyword">var</span>/www/awesome-<span class="keyword">app</span></span><br><span class="line"></span><br><span class="line">  Options -Indexes</span><br><span class="line"></span><br><span class="line">  ErrorLog /<span class="keyword">var</span>/<span class="keyword">log</span>/apache2/<span class="keyword">error</span>.<span class="built_in">log</span></span><br><span class="line">  TransferLog /<span class="keyword">var</span>/<span class="keyword">log</span>/apache2/access.<span class="built_in">log</span></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure></p><p>现在，快速更新一下我们的 apache 剧本，我们准备好了:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installs apache web server</span><br><span class="line">      apt:</span><br><span class="line">        pkg: apache2</span><br><span class="line">        state: present</span><br><span class="line">        update_cache: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    - name: Push<span class="built_in"> default </span>virtual host configuration</span><br><span class="line">      copy:</span><br><span class="line">        src: files/awesome-app</span><br><span class="line">        dest: /etc/apache2/sites-available/awesome-app</span><br><span class="line">        mode: 0640</span><br><span class="line"></span><br><span class="line">    - name: <span class="builtin-name">Disable</span> the<span class="built_in"> default </span>virtualhost</span><br><span class="line">      file:</span><br><span class="line">        dest: /etc/apache2/sites-enabled/default</span><br><span class="line">        state: absent</span><br><span class="line">      notify:</span><br><span class="line">        - restart apache</span><br><span class="line"></span><br><span class="line">    - name: <span class="builtin-name">Disable</span> the<span class="built_in"> default </span>ssl virtualhost</span><br><span class="line">      file:</span><br><span class="line">        dest: /etc/apache2/sites-enabled/default-ssl</span><br><span class="line">        state: absent</span><br><span class="line">      notify:</span><br><span class="line">        - restart apache</span><br><span class="line"></span><br><span class="line">    - name: Activates our virtualhost</span><br><span class="line">      file:</span><br><span class="line">        src: /etc/apache2/sites-available/awesome-app</span><br><span class="line">        dest: /etc/apache2/sites-enabled/awesome-app</span><br><span class="line">        state: link</span><br><span class="line">      notify:</span><br><span class="line">        - restart apache</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart apache</span><br><span class="line">      service:</span><br><span class="line">        name: apache2</span><br><span class="line">        state: restarted</span><br></pre></td></tr></table></figure><p>我们开始吧:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -i step-05/hosts -l host1 step-05/apache.yml</span><br><span class="line"></span><br><span class="line">PLAY [web] *********************</span><br><span class="line"></span><br><span class="line">GATHERING FACTS *********************</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Installs apache web server] *********************</span><br><span class="line">ok: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Push<span class="built_in"> default </span>virtual host configuration] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [<span class="builtin-name">Disable</span> the<span class="built_in"> default </span>virtualhost] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [<span class="builtin-name">Disable</span> the<span class="built_in"> default </span>ssl virtualhost] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">TASK: [Activates our virtualhost] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">NOTIFIED: [restart apache] *********************</span><br><span class="line">changed: [host1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************</span><br><span class="line">host1              : <span class="attribute">ok</span>=7    <span class="attribute">changed</span>=5    <span class="attribute">unreachable</span>=0    <span class="attribute">failed</span>=0</span><br></pre></td></tr></table></figure><p>太酷了！好吧，想想看，我们有点操之过急了。在重新启动 apache 之前，我们是否应该检查一下配置是否正常？这样，如果配置文件不正确，我们就不会中断服务。</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>翻译: ansible-tuto（02-03）</title>
    <link href="http://yoursite.com/2020/05/10/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8802-03%EF%BC%89/"/>
    <id>http://yoursite.com/2020/05/10/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8802-03%EF%BC%89/</id>
    <published>2020-05-10T12:32:28.000Z</published>
    <updated>2020-05-11T02:43:05.923Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="step-02-talking-to-nodes"><a href="#step-02-talking-to-nodes" class="headerlink" title="step-02 talking to nodes"></a>step-02 talking to nodes</h1><p>现在我们可以开始了。 让我们用上一章中看到的命令: <code>anable</code> 这个命令是ansible提供的与节点交互的三个命令中的一个</p><h3 id="做些有用的事情"><a href="#做些有用的事情" class="headerlink" title="做些有用的事情"></a>做些有用的事情</h3><p>在前面的命令中,<code>-m ping</code> 的意思是“使用 ping模块”，这个模块是可用的许多模块之一。 <code>Ping</code> 模块非常简单，不需要任何参数。 接受参数的模块通过 <code>-a</code> 来传递参数，让我们看看其他一些模块</p><h3 id="shell模块"><a href="#shell模块" class="headerlink" title="shell模块"></a>shell模块</h3><p>这个模块允许你在远程主机上执行一个 shell 命令:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -<span class="selector-tag">i</span> step-<span class="number">02</span>/hosts -m shell -<span class="selector-tag">a</span> <span class="string">'uname -a'</span> host0</span><br></pre></td></tr></table></figure></p><p>输出应该是这样的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>cool!</p><h3 id="copy模块"><a href="#copy模块" class="headerlink" title="copy模块"></a>copy模块</h3><p>毫无疑问，使用这个模块，您可以将文件从控制机复制到节点，假设我们要将 <code>/etc/hosts</code> 复制到目标节点的 <code>/tmp</code>:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -<span class="selector-tag">i</span> step-<span class="number">02</span>/hosts -m copy -<span class="selector-tag">a</span> <span class="string">'src=/etc/hosts dest=/tmp/'</span> host0</span><br></pre></td></tr></table></figure></p><p>输出应该类似于:<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">host0 <span class="string">| success &gt;&gt; &#123;</span></span><br><span class="line">    <span class="string">"changed"</span>: true,</span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/hosts"</span>,</span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>,</span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"d41d8cd98f00b204e9800998ecf8427e"</span>,</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0644"</span>,</span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-1362910475.9-246937081757218/source"</span>,</span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Ansible (更准确地说是在节点上执行的复制模块)以 JSON 格式回复了大量有用的信息,我们稍后将看到如何使用它。</p><p>我们将在下面看到其他有用的模块,有一个巨大的<a href="https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html），几乎涵盖了你可以在系统上做的任何事情。 如果您找不到合适的模块，那么编写一个模块非常简单(甚至不必是 Python，只需要使用 JSON" target="_blank" rel="noopener">模块仓库</a></p><h3 id="对不同的主机使用相同的命令"><a href="#对不同的主机使用相同的命令" class="headerlink" title="对不同的主机使用相同的命令"></a>对不同的主机使用相同的命令</h3><p>好的，上面的内容很有趣，但是我们有很多节点需要管理。让我们在其他主机上也尝试一下</p><p>让我们假设我们想要得到一些关于节点的信息，例如，想知道我们在节点上部署了哪个 Ubuntu 版本，这很简单:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -<span class="selector-tag">i</span> step-<span class="number">02</span>/hosts -m shell -<span class="selector-tag">a</span> <span class="string">'grep DISTRIB_RELEASE /etc/lsb-release'</span> all</span><br></pre></td></tr></table></figure></p><p>All 是一个快捷方式，意思是“在目录文件中找到的所有主机”。它会返回:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">host1 | success | <span class="attribute">rc</span>=0 &gt;&gt;</span><br><span class="line"><span class="attribute">DISTRIB_RELEASE</span>=14.04</span><br><span class="line"></span><br><span class="line">host2 | success | <span class="attribute">rc</span>=0 &gt;&gt;</span><br><span class="line"><span class="attribute">DISTRIB_RELEASE</span>=14.04</span><br><span class="line"></span><br><span class="line">host0 | success | <span class="attribute">rc</span>=0 &gt;&gt;</span><br><span class="line"><span class="attribute">DISTRIB_RELEASE</span>=14.04</span><br></pre></td></tr></table></figure><h3 id="更多的facts（信息）"><a href="#更多的facts（信息）" class="headerlink" title="更多的facts（信息）"></a>更多的facts（信息）</h3><p>这很简单，然而，如果我们想要更多的信息(ip 地址，RAM 大小等等)，它会很快变得很麻烦. 这个解决方案来自另一个非常方便的模块，叫做<code>setup</code>: 它专门收集节点的facts（信息）</p><p>尝试一下:<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i <span class="built_in">step</span><span class="number">-02</span>/hosts -m <span class="built_in">setup</span> host0</span><br></pre></td></tr></table></figure></p><p>提供大量信息:<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">    <span class="string">"ansible_all_ipv4_addresses"</span>: [</span><br><span class="line">        <span class="string">"192.168.0.60"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"ansible_all_ipv6_addresses"</span>: [],</span><br><span class="line">    <span class="string">"ansible_architecture"</span>: <span class="string">"x86_64"</span>,</span><br><span class="line">    <span class="string">"ansible_bios_date"</span>: <span class="string">"01/01/2007"</span>,</span><br><span class="line">    <span class="string">"ansible_bios_version"</span>: <span class="string">"Bochs"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">---snip---</span></span><br><span class="line">    <span class="string">"ansible_virtualization_role"</span>: <span class="string">"guest"</span>,</span><br><span class="line">    <span class="string">"ansible_virtualization_type"</span>: <span class="string">"kvm"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">"verbose_override"</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>为了简短起见，对它进行了截断，但是您可以在返回的数据中找到许多有趣的,您还可以过滤返回的键，以防您正在寻找某些特定的东西。</p><p>例如，让我们假设你想知道你在所有主机上有多少内存，简单地使用 <code>ansible -i step-02/hosts -m setup -a &quot;filter= ansible_memtotal_mb&quot; all:</code></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">host2 <span class="string">| success &gt;&gt; &#123;</span></span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_memtotal_mb"</span>: <span class="number">187</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">host1 <span class="string">| success &gt;&gt; &#123;</span></span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_memtotal_mb"</span>: <span class="number">187</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">host0 <span class="string">| success &gt;&gt; &#123;</span></span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_memtotal_mb"</span>: <span class="number">187</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请注意，与前面的输出相比，主机的回复顺序不同，这是因为 ansible 与主机的通信是并行化的！</p><p>顺便说一句，在使用 <code>setup</code> 模块时，可以在 <code>filter=</code> 表达式中使用 <code>*</code>，它与<code>shell</code>相似</p><h3 id="选择主机"><a href="#选择主机" class="headerlink" title="选择主机"></a>选择主机</h3><p>我们看到 <code>all</code> 意味着所有的主机，但 ansible 提供了许多其他的方法来<a href="https://docs.ansible.com/ansible/latest/user_guide/intro_patterns.html" target="_blank" rel="noopener">选择主机</a>:</p><ul><li><code>host0:host1</code>  将在 host0和 host1上运行</li><li><code>host*</code> host开头的主机都会运行 (就像 shell语法一样)</li></ul><p>还有其他涉及主机组的方式，我们将在step-03中看到。</p><h1 id="step-03-主机组"><a href="#step-03-主机组" class="headerlink" title="step-03 主机组"></a>step-03 主机组</h1><p>库存中的主机可以任意分组，例如，您可以有一个 <code>debian</code> 组、一个 <code>web-server</code> 组、一个 <code>production</code> 组等等</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[debian]</span></span><br><span class="line">host0</span><br><span class="line">host1</span><br><span class="line">host2</span><br></pre></td></tr></table></figure><p>这甚至可以用更简短的方式来表达:<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[debian]</span></span><br><span class="line">host<span class="string">[0:2]</span></span><br></pre></td></tr></table></figure></p><p>如果您希望使用子组，只需定义一个 <code>[ groupname: children ]</code> 并在其中添加子组，例如，假设我们有不同发行版的 linux 运行，我们可以这样组织我们的库存:<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[ubuntu]</span></span><br><span class="line">host0</span><br><span class="line"></span><br><span class="line"><span class="string">[debian]</span></span><br><span class="line">host<span class="string">[1:2]</span></span><br><span class="line"></span><br><span class="line"><span class="string">[linux:children]</span></span><br><span class="line">ubuntu</span><br><span class="line">debian</span><br></pre></td></tr></table></figure></p><h3 id="设置变量"><a href="#设置变量" class="headerlink" title="设置变量"></a>设置变量</h3><p>您可以在几个地方为主机分配变量: 库存文件、主机变量文件、组 v变量文件等等</p><p>我通常将大部分变量设置在组变量或主机变量文件中(稍后将详细介绍)。但是，我经常直接在目录文件中使用一些变量，比如<code>ansible_host</code> 可以为主机设置 IP 地址。 默认情况下，Ansible 会在通过 SSH 连接时尝试解析主机的名称。 当在你启动一个主机时，它可能还没有一个确定的 IP 地址，<code>ansible_host</code> 用在这里很方便</p><p>当使用 <code>ansible</code> 或 <code>ansible-playbook</code> 命令时，也可以使用参数 <code>--extra-vars</code> (或<code>-e</code>)来设置变量，作为空格分隔的<code>key=val</code> 列表(对于每个变量的初始化，可以多次使用该方法)。 我们将在下一步讨论<code>ansible-playbook</code></p><p>您可以猜到，<code>ansible_port</code>指定一个 SSH 端口尝试连接<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ubuntu]</span><br><span class="line">host0 ansible_host=<span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span> ansible_port=<span class="number">2222</span></span><br></pre></td></tr></table></figure></p><p>Ansible 将在组和主机变量文件中查找其他变量定义,这些文件在主目录文件所在的目录下的 <code>group_vars</code> 和 <code>host_vars</code> 的目录中搜索</p><p>文件将按名称搜索，例如，使用前面提到的库存文件，<code>host0</code>变量将在这些文件中搜索</p><ul><li><code>group_vars/linux</code></li><li><code>group_vars/ubuntu</code></li><li><code>host_vars/host0</code><br>~~~<br>这些文件是否存在并不重要，但是如果它们存在，ansible 将使用它们</li></ul><p>现在我们已经了解了模块、库存和变量的基本知识，让我们通过剧本来探索 Ansible 的真正力量</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>LVS学习</title>
    <link href="http://yoursite.com/2020/05/10/LVS%E5%AD%A6%E4%B9%A0/"/>
    <id>http://yoursite.com/2020/05/10/LVS%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-05-10T03:52:49.000Z</published>
    <updated>2020-05-11T03:58:21.348Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>记录的非常详细,值得学习–&gt; <a href="http://superproxy.github.io/docs/lvs/index.html" target="_blank" rel="noopener">LVS介绍</a></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="LVS" scheme="http://yoursite.com/tags/LVS/"/>
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>翻译: ansible-tuto（00-01）</title>
    <link href="http://yoursite.com/2020/05/08/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8800-01%EF%BC%89/"/>
    <id>http://yoursite.com/2020/05/08/%E7%BF%BB%E8%AF%91-ansible-tuto%EF%BC%8800-01%EF%BC%89/</id>
    <published>2020-05-08T13:29:00.000Z</published>
    <updated>2020-05-09T14:34:19.551Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>官方文档虽好，样样俱全，可就是太碎太细，难以拼接消化，那么就先从跟着一份好的教程先慢慢学起吧</p><p>源地址（包含所有所需文件）–&gt;<a href="https://github.com/leucos/ansible-tuto" target="_blank" rel="noopener">ansible-tuto</a></p><h1 id="step-00-安装"><a href="#step-00-安装" class="headerlink" title="step-00 安装"></a>step-00 安装</h1><p>Vagrant的出现让VirtualBox部署虚拟机变得非常简单容易，为了让本教程更加<code>self-contained</code>，已经提供了所需的Vagrantfile</p><h3 id="安装vagrant"><a href="#安装vagrant" class="headerlink" title="安装vagrant"></a>安装vagrant</h3><p>为了运行Vagrant，需要满足以下条件：</p><ul><li>安装VirtualBox</li><li>安装Ruby</li><li>安装Vagrant（1.1版本以上）<br>以上就是安装Vagrant所需的</li></ul><p>现在就可以根据以下命令去启动你的虚拟机了。请注意，你不需要手动下载任何<code>box</code>，本教程已经提供了一个所需的Vagrantfile，如果还需要其他的，那么还会提供另外一个的<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vagrant up</span></span><br></pre></td></tr></table></figure></p><p>然后可以放松下去喝杯咖啡(注意，如果您使用 vagrant-hostmaster，您需要输入密码，因为sudo 提权需要密码)</p><p>如果有什么地方出了问题，请参考 <a href="https://www.vagrantup.com/intro/getting-started/index.html" target="_blank" rel="noopener">Getting Started Guide</a></p><h3 id="关于NetworkManager的警示"><a href="#关于NetworkManager的警示" class="headerlink" title="关于NetworkManager的警示"></a>关于NetworkManager的警示</h3><p>在某些系统上，<code>NetworkManager</code> 将接管 <code>vboxnet</code> 接口，并把一切都搞砸。 如果是这种情况，应该防止 <code>NetworkManager</code> 尝试自动配置<code>vboxnet</code>接口。 只需编辑 <code>/etc/networkmanager/networkmanager.conf</code> (或者你系统中的 NetworkManager 配置文件)并添加一节[keyfile] :<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unmanaged-devices=<span class="string">mac:</span>MAC_OF_VBOXNET0_IF;<span class="string">mac:</span>MAC_OF_VBOXNET1_IF;...</span><br></pre></td></tr></table></figure></p><p>然后销毁 Vagrant 计算机，重新启动 NetworkManager，然后再试一次。</p><h3 id="为虚拟机添加SSH密钥"><a href="#为虚拟机添加SSH密钥" class="headerlink" title="为虚拟机添加SSH密钥"></a>为虚拟机添加SSH密钥</h3><p>按照该教程，您需要将您的密钥放在虚拟机中<code>root</code>用户文件夹中<code>authorized_keys</code>中，虽然这是不是绝对必要的(ansible可以使用 sudo，密码身份验证等) 但这样事情就简单多了</p><p>ansible非常擅长这个，然而，我现在不会解释发生了什么，相信我<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i <span class="built_in">step</span><span class="number">-00</span>/hosts <span class="built_in">step</span><span class="number">-00</span>/<span class="built_in">setup</span>.yml</span><br></pre></td></tr></table></figure></p><p>如果出现“超时连接”错误，请检查机器的防火墙设置。</p><p>如果出现以下错误:<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fatal: [<span class="number">192.168</span><span class="number">.33</span><span class="number">.10</span>]: UNREACHABLE! =&gt; &#123;<span class="string">"changed"</span>: <span class="keyword">false</span>, </span><br><span class="line"><span class="string">"msg"</span>: <span class="string">"host key mismatch for 192.168.33.10"</span>, <span class="string">"unreachable"</span>: <span class="keyword">true</span>&#125;</span><br></pre></td></tr></table></figure></p><p>那么你可能已经在你的 <code>~/.ssh/known_hosts</code> 中有了那些 IP 的SSH主机密钥, 您可以使用<code>ssh-keygen-r ip</code>删除它们</p><p>然后，只要在提示访问 ssh 主机密钥(如果请求)时输入 <code>yes</code> 即可。</p><p><strong>注意</strong>: 我们假设您正在本地机器上使用 Ansible v2.5 + 版本。 如果没有，您应该在使用该存储库之前将其升级到 v2.5 + (或在 virtualenv 下运行)。</p><h1 id="step-01-Inventory"><a href="#step-01-Inventory" class="headerlink" title="step-01 Inventory"></a>step-01 Inventory</h1><p>在继续之前，您需要一个库存（invertory)文件，该文件文件的默认位置是 <code>/etc /anable/hosts</code>  然而，你可以通过配置 anable 去将其存储在其他地方，或使用环境变量（ANSIBLE_INVENTORY）指明库存路径，或者使用 <code>ansible</code> 命令中的  <code>-i</code>标志指明库存路径。</p><p>我们在目录中为您创建了一个库存文件，如下所示:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">host0 <span class="attribute">ansible_host</span>=192.168.33.10 <span class="attribute">ansible_user</span>=root</span><br><span class="line">host1 <span class="attribute">ansible_host</span>=192.168.33.11 <span class="attribute">ansible_user</span>=root</span><br><span class="line">host2 <span class="attribute">ansible_host</span>=192.168.33.12 <span class="attribute">ansible_user</span>=root</span><br></pre></td></tr></table></figure></p><p><code>ansible_host</code> 是一个特殊的变量，它代表着主机连接时使用的 IP 地址。 如果您使用 <code>vagrant-hostmaster gem</code> ，那么在这里就没有必要了。 此外，如果您已经使用不同的ip地址设置了自己的虚拟机，则必须更改 ip</p><p><code>Ansible_user</code> 是另一个特殊的变量，它告诉 ansible 在使用 ssh 时以这个用户的身份连接。 默认情况下，ansible 将使用您当前的用户名，或者使用 <code>~/.ansible.cfg</code> 中提供的另一个默认用户名</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>ansible 安装好了，让我们检查一下是否一切正常<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -m<span class="built_in"> ping </span>all -i step-01/hosts</span><br></pre></td></tr></table></figure></p><p>Ansible 在这里尝试做的只是在每个主机上执行 <code>ping</code> 模块(稍后在模块中进一步介绍)</p><p>输出应该是这样的:<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">host0 <span class="string">| success &gt;&gt; &#123;</span></span><br><span class="line">    <span class="string">"changed"</span>: false,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">host1 <span class="string">| success &gt;&gt; &#123;</span></span><br><span class="line">    <span class="string">"changed"</span>: false,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">host2 <span class="string">| success &gt;&gt; &#123;</span></span><br><span class="line">    <span class="string">"changed"</span>: false,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p>以下为安装ssh密钥所用到的 <code>playbook</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">become:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">become_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">remote_user:</span> <span class="string">vagrant</span></span><br><span class="line"><span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="comment"># This should work too / #2372</span></span><br><span class="line"><span class="comment"># - name: Pushes user key to root's on vagrant boxes</span></span><br><span class="line"><span class="comment">#   action: authorized_key key=$FILE($item) user=root</span></span><br><span class="line"><span class="comment">#   first_available_file:</span></span><br><span class="line"><span class="comment">#     - ~/.ssh/id_dsa.pub</span></span><br><span class="line"><span class="comment">#     - ~/.ssh/id_rsa.pub</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">ssh</span> <span class="string">to</span> <span class="string">be</span> <span class="string">up</span></span><br><span class="line"><span class="attr">become:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">wait_for:</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">22</span></span><br><span class="line"><span class="attr">delay:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">connect_timeout:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">timeout:</span> <span class="number">360</span></span><br><span class="line"><span class="attr">host:</span> <span class="string">"<span class="template-variable">&#123;&#123; ansible_host &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">delegate_to:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Installs</span> <span class="string">python</span></span><br><span class="line"><span class="attr">raw:</span> <span class="string">apt-get</span> <span class="string">update</span> <span class="string">&amp;&amp;</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="bullet">-y</span> <span class="string">python</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Creates</span> <span class="string">destination</span> <span class="string">directory</span></span><br><span class="line"><span class="comment"># Workaround for #2372</span></span><br><span class="line"><span class="attr">file:</span></span><br><span class="line"><span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"><span class="attr">mode:</span> <span class="number">0700</span></span><br><span class="line"><span class="attr">dest:</span> <span class="string">/root/.ssh/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Pushes</span> <span class="string">user's</span> <span class="string">rsa</span> <span class="string">key</span> <span class="string">to</span> <span class="string">root's</span> <span class="string">vagrant</span> <span class="string">box</span> <span class="string">(it's</span> <span class="string">ok</span> <span class="string">if</span> <span class="string">this</span> <span class="string">TASK</span> <span class="string">fails)</span></span><br><span class="line"><span class="comment"># action: authorized_key user=root key='$FILE(~/.ssh/id_rsa.pub)'</span></span><br><span class="line"><span class="comment"># Workaround for #2372</span></span><br><span class="line"><span class="attr">copy:</span></span><br><span class="line"><span class="attr">src:</span> <span class="string">~/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">dest:</span> <span class="string">/root/.ssh/authorized_keys</span></span><br><span class="line"><span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">mode:</span> <span class="number">0600</span></span><br><span class="line"><span class="attr">register:</span> <span class="string">rsa</span></span><br><span class="line"><span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Pushes</span> <span class="string">user's</span> <span class="string">dsa</span> <span class="string">key</span> <span class="string">to</span> <span class="string">root's</span> <span class="string">vagrant</span> <span class="string">box</span> <span class="string">(it's</span> <span class="string">NOT</span> <span class="string">ok</span> <span class="string">if</span> <span class="string">both</span> <span class="string">TASKs</span> <span class="string">fail)</span></span><br><span class="line"><span class="comment"># action: authorized_key user=root key='$FILE(~/.ssh/id_dsa.pub)'</span></span><br><span class="line"><span class="comment"># Workaround for #2372</span></span><br><span class="line"><span class="attr">copy:</span></span><br><span class="line"><span class="attr">src:</span> <span class="string">~/.ssh/id_dsa.pub</span></span><br><span class="line"><span class="attr">dest:</span> <span class="string">/root/.ssh/authorized_keys</span></span><br><span class="line"><span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">mode:</span> <span class="number">0600</span></span><br><span class="line"><span class="attr">when:</span> <span class="string">rsa</span> <span class="string">is</span> <span class="string">failed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Checks</span> <span class="string">if</span> <span class="string">resolver</span> <span class="string">is</span> <span class="string">working</span> <span class="string">properly</span> <span class="string">(issues</span> <span class="string">with</span> <span class="string">some</span> <span class="string">VBox/Host</span> <span class="string">OS</span> <span class="string">combinations)</span></span><br><span class="line"><span class="attr">command:</span> <span class="string">host</span> <span class="bullet">-t</span> <span class="string">A</span> <span class="string">ansible.cc</span></span><br><span class="line"><span class="attr">register:</span> <span class="string">ns</span></span><br><span class="line"><span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Pushes</span> <span class="string">new</span> <span class="string">resolver</span> <span class="string">configuration</span> <span class="string">if</span> <span class="string">resolver</span> <span class="string">fails</span></span><br><span class="line"><span class="attr">lineinfile:</span></span><br><span class="line"><span class="attr">regexp:</span> <span class="string">"^nameserver "</span></span><br><span class="line"><span class="attr">line:</span> <span class="string">"nameserver 8.8.8.8"</span></span><br><span class="line"><span class="attr">dest:</span> <span class="string">/etc/resolv.conf</span></span><br><span class="line"><span class="attr">when:</span> <span class="string">ns</span> <span class="string">is</span> <span class="string">failed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Checks</span> <span class="string">if</span> <span class="string">resolver</span> <span class="string">is</span> <span class="string">working</span> <span class="string">properly</span> <span class="string">with</span> <span class="string">new</span> <span class="string">nameserver</span></span><br><span class="line"><span class="attr">command:</span> <span class="string">host</span> <span class="bullet">-t</span> <span class="string">A</span> <span class="string">ansible.cc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Final</span> <span class="string">greeting</span></span><br><span class="line"><span class="attr">pause:</span></span><br><span class="line"><span class="attr">seconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">echo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">prompt:</span> <span class="string">"Don't worry about all the red above; if you made it here, your Vagrant VMs are probably fine !"</span></span><br></pre></td></tr></table></figure></p><ul><li>首先，playbook的文件格式为 <code>yaml</code></li></ul><p>为了方便将其分开来说明<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">become:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">become_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">remote_user:</span> <span class="string">vagrant</span></span><br><span class="line"><span class="attr">gather_facts:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><ul><li>每一个剧本都应指明相应的host也就是inventory（库存里的主机），默认的hosts文件在 <code>/etc/ansible/hosts</code> ,当然也可以将 <code>hosts</code> 文件存放在自己指定的位置，最后在执行 <code>ansible-play</code>时加上 <code>-i</code>参数指明路径，而 <code>all</code> 就代表着所有主机 </li><li>这里的 <code>become</code> 代表着提权，默认方式为 <code>sudo</code>，也可以指定其他方式，如 <code>become_method: su</code></li><li><code>become_user</code> 就好理解了，为提权后的用户</li><li>要用到提权难免会输入密码，此时运行该剧本时就应加上 <code>-k</code> 或 <code>--ask-become-pass</code></li><li><code>remote_user</code> 为远程登录用户</li><li><code>gather_facts</code> 用于收集系统信息，不需要时关闭可提高运行速度</li></ul><p>接下来就是<code>tasks</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Creates</span> <span class="string">destination</span> <span class="string">directory</span></span><br><span class="line"><span class="comment"># Workaround for #2372</span></span><br><span class="line"><span class="attr">file:</span></span><br><span class="line"><span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"><span class="attr">mode:</span> <span class="number">0700</span></span><br><span class="line"><span class="attr">dest:</span> <span class="string">/root/.ssh/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Pushes</span> <span class="string">user's</span> <span class="string">rsa</span> <span class="string">key</span> <span class="string">to</span> <span class="string">root's</span> <span class="string">vagrant</span> <span class="string">box</span> <span class="string">(it's</span> <span class="string">ok</span> <span class="string">if</span> <span class="string">this</span> <span class="string">TASK</span> <span class="string">fails)</span></span><br><span class="line"><span class="comment"># action: authorized_key user=root key='$FILE(~/.ssh/id_rsa.pub)'</span></span><br><span class="line"><span class="comment"># Workaround for #2372</span></span><br><span class="line"><span class="attr">copy:</span></span><br><span class="line"><span class="attr">src:</span> <span class="string">~/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">dest:</span> <span class="string">/root/.ssh/authorized_keys</span></span><br><span class="line"><span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">mode:</span> <span class="number">0600</span></span><br><span class="line"><span class="attr">register:</span> <span class="string">rsa</span></span><br><span class="line"><span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><ul><li>根据 <code>yaml</code> 语法，<code>-</code>表示的是一个数组，后面的 <code>name</code> 可有可无，为了有更好的辨明度，最好加上</li><li>后面最先接的是一个模块名称，再后面就是进行的操作，之后的教程会说到</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;官方文档虽好，样样俱全，可就是太碎太细，难以拼接消化，那么就先从跟着一份好的教程先慢慢学起吧&lt;/p&gt;
&lt;p&gt;源地址（包含所有所需文件）–&amp;g
      
    
    </summary>
    
    
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>vagrant学习</title>
    <link href="http://yoursite.com/2020/05/06/vagrant%E5%AD%A6%E4%B9%A0/"/>
    <id>http://yoursite.com/2020/05/06/vagrant%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-05-06T04:36:14.000Z</published>
    <updated>2020-05-06T14:02:27.285Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="什么是vagrant"><a href="#什么是vagrant" class="headerlink" title="什么是vagrant"></a>什么是vagrant</h1><blockquote><p>Vagrant is a tool for building and managing virtual machine environments in a single workflow. With an easy-to-use workflow and focus on automation, Vagrant lowers development environment setup time, increases production parity, and makes the “works on my machine” excuse a relic of the past.</p><ul><li>简而言之，即是一次打包，随处使用</li></ul></blockquote><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>vagrant 支持多种虚拟化软件</p><ul><li>VirualBox</li><li>Vmware(付费)</li><li>KVM</li><li>Hyper-v</li></ul><p>这里用到的是 virtualbox（默认支持），注意需先安装 virtualbox，再安装 vagrant，否则会出现找不到 virualbox 的错误，需重新安装</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo pacman -S virualbox</span></span><br></pre></td></tr></table></figure><ul><li>安装后还需加载相应内核模块<code>modprobe -a vboxdrv</code></li></ul><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo pacman -S vagrant</span></span><br></pre></td></tr></table></figure><h1 id="什么是box"><a href="#什么是box" class="headerlink" title="什么是box"></a>什么是box</h1><p>box 是vagrant环境的一种打包格式，在所有vagrant支持的操作系统上是通用的，而后面所有进行的操作都与box息息相关（类似于docker中的镜像）</p><p>这是box商店 —&gt; <a href="https://app.vagrantup.com/boxes/search" target="_blank" rel="noopener">door</a></p><ul><li>在这里可以找到各种想要发行版或服务</li></ul><p>每个box以 <code>作者名/box名</code>加以区分</p><p>添加一个box<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">vagrant</span> <span class="keyword">box </span><span class="keyword">add </span>ubuntu/trusty64</span><br></pre></td></tr></table></figure></p><ul><li><p>可以是本地文件，也可以是一个下载地址</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant <span class="type">box</span> <span class="keyword">add</span> \</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/<span class="keyword">current</span>/bionic-<span class="keyword">server</span>-cloudimg-amd64-vagrant.box \</span><br><span class="line"><span class="comment">--name ubuntu/bionic</span></span><br></pre></td></tr></table></figure></li><li><p>就像这样</p></li></ul><p>查看刚刚添加的box<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant box <span class="built_in">list</span></span><br></pre></td></tr></table></figure></p><p>删除<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant <span class="built_in">box</span> <span class="built_in">remove</span> name</span><br></pre></td></tr></table></figure></p><h1 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h1><p>了解了box，就可以正式开始了</p><p>先新建一个文件夹，作为本次的大本营,初始化<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> <span class="keyword">my</span>-vagrant</span><br><span class="line">cd <span class="keyword">my</span>-vagrant</span><br><span class="line"></span><br><span class="line">vagrant init ubuntu/trusty64</span><br></pre></td></tr></table></figure></p><ul><li>init 指定一个box，也可以是一个url</li></ul><p>这样在当前目录就生成了一个Vagrantfile，作为我们的初始配置文件<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: ruby -*-</span></span><br><span class="line"><span class="comment"># vi: set ft=ruby :</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># All Vagrant configuration is done below. The "2" in Vagrant.configure</span></span><br><span class="line"><span class="comment"># configures the configuration version (we support older styles for</span></span><br><span class="line"><span class="comment"># backwards compatibility). Please don't change it unless you know what</span></span><br><span class="line"><span class="comment"># you're doing.</span></span><br><span class="line">Vagrant.configure(<span class="string">"2"</span>) <span class="keyword">do</span> |config|</span><br><span class="line">  <span class="comment"># The most common configuration options are documented and commented below.</span></span><br><span class="line">  <span class="comment"># For a complete reference, please see the online documentation at</span></span><br><span class="line">  <span class="comment"># https://docs.vagrantup.com.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Every Vagrant development environment requires a box. You can search for</span></span><br><span class="line">  <span class="comment"># boxes at https://vagrantcloud.com/search.</span></span><br><span class="line">  config.vm.box = <span class="string">"ubuntu/trusty64"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Disable automatic box update checking. If you disable this, then</span></span><br><span class="line">  <span class="comment"># boxes will only be checked for updates when the user runs</span></span><br><span class="line">  <span class="comment"># `vagrant box outdated`. This is not recommended.</span></span><br><span class="line">  <span class="comment"># config.vm.box_check_update = false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a forwarded port mapping which allows access to a specific port</span></span><br><span class="line">  <span class="comment"># within the machine from a port on the host machine. In the example below,</span></span><br><span class="line">  <span class="comment"># accessing "localhost:8080" will access port 80 on the guest machine.</span></span><br><span class="line">  <span class="comment"># <span class="doctag">NOTE:</span> This will enable public access to the opened port</span></span><br><span class="line">  <span class="comment"># config.vm.network "forwarded_port", guest: 80, host: 8080</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a forwarded port mapping which allows access to a specific port</span></span><br><span class="line">  <span class="comment"># within the machine from a port on the host machine and only allow access</span></span><br><span class="line">  <span class="comment"># via 127.0.0.1 to disable public access</span></span><br><span class="line">  <span class="comment"># config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a private network, which allows host-only access to the machine</span></span><br><span class="line">  <span class="comment"># using a specific IP.</span></span><br><span class="line">  <span class="comment"># config.vm.network "private_network", ip: "192.168.33.10"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a public network, which generally matched to bridged network.</span></span><br><span class="line">  <span class="comment"># Bridged networks make the machine appear as another physical device on</span></span><br><span class="line">  <span class="comment"># your network.</span></span><br><span class="line">  <span class="comment"># config.vm.network "public_network"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Share an additional folder to the guest VM. The first argument is</span></span><br><span class="line">  <span class="comment"># the path on the host to the actual folder. The second argument is</span></span><br><span class="line">  <span class="comment"># the path on the guest to mount the folder. And the optional third</span></span><br><span class="line">  <span class="comment"># argument is a set of non-required options.</span></span><br><span class="line">  <span class="comment"># config.vm.synced_folder "../data", "/vagrant_data"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Provider-specific configuration so you can fine-tune various</span></span><br><span class="line">  <span class="comment"># backing providers for Vagrant. These expose provider-specific options.</span></span><br><span class="line">  <span class="comment"># Example for VirtualBox:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># config.vm.provider "virtualbox" do |vb|</span></span><br><span class="line">  <span class="comment">#   # Display the VirtualBox GUI when booting the machine</span></span><br><span class="line">  <span class="comment">#   vb.gui = true</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#   # Customize the amount of memory on the VM:</span></span><br><span class="line">  <span class="comment">#   vb.memory = "1024"</span></span><br><span class="line">  <span class="comment"># end</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># View the documentation for the provider you are using for more</span></span><br><span class="line">  <span class="comment"># information on available options.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Enable provisioning with a shell script. Additional provisioners such as</span></span><br><span class="line">  <span class="comment"># Ansible, Chef, Docker, Puppet and Salt are also available. Please see the</span></span><br><span class="line">  <span class="comment"># documentation for more information about their specific syntax and use.</span></span><br><span class="line">  <span class="comment"># config.vm.provision "shell", inline: &lt;&lt;-SHELL</span></span><br><span class="line">  <span class="comment">#   apt-get update</span></span><br><span class="line">  <span class="comment">#   apt-get install -y apache2</span></span><br><span class="line">  <span class="comment"># SHELL</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p><ul><li>配置文件的语法格式为ruby</li></ul><p>相关配置块共有5种：</p><ul><li>config.vm 与虚拟机相关配置</li><li>config.ssh 与ssh相关配置</li><li>config.vagrant 与vagrant自身相关配置</li><li>config.winrm 与Windows远程管理相关配置</li><li>config.winssh 与Windows平台上ssh相关配置</li></ul><p>最常用的还是config.vm</p><table><thead><tr><th style="text-align:center">config.vm.box</th><th style="text-align:center">指定一个box（初始化时就已经自动填好）</th></tr></thead><tbody><tr><td style="text-align:center">config.vm.box_version</td><td style="text-align:center">指定一个box的版本</td></tr><tr><td style="text-align:center">comfig.vm.define</td><td style="text-align:center">为这个虚拟机取个名（默认为default）</td></tr></tbody></table><p><a href="https://www.vagrantup.com/docs/vagrantfile/machine_settings.html" target="_blank" rel="noopener">更多设置</a></p><p>开始启动<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vagrant up</span></span><br></pre></td></tr></table></figure></p><ul><li>这样过一会虚拟机就会启动完成了</li></ul><p>关机、重启<br><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vagrant</span> <span class="string">halt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">vagrant</span> <span class="string">reload</span></span><br></pre></td></tr></table></figure></p><h1 id="ssh管理"><a href="#ssh管理" class="headerlink" title="ssh管理"></a>ssh管理</h1><p>创建完成后已经自动设置好了ssh，查看配置<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh-config</span><br><span class="line"></span><br><span class="line">&gt;</span><br><span class="line">Host default</span><br><span class="line">HostName 127.0.0.1</span><br><span class="line">User vagrant</span><br><span class="line">Port 2222</span><br><span class="line">UserKnownHostsFile /dev/<span class="literal">null</span></span><br><span class="line">StrictHostKeyChecking <span class="literal">no</span></span><br><span class="line">PasswordAuthentication <span class="literal">no</span></span><br><span class="line">IdentityFile /home/test/my-vagrant/.vagrant/machines/default/virtualbox/private_key</span><br><span class="line">IdentitiesOnly <span class="literal">yes</span></span><br><span class="line">LogLevel FATAL</span><br></pre></td></tr></table></figure></p><ul><li>可以得到几个重要信息：ip、端口、用户名、密钥地址</li></ul><p>连接虚拟机<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh </span><br><span class="line"></span><br><span class="line"># 等同于 ssh <span class="symbol">vagrant@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">2222</span> -i ~/my—vagrant/.vagrant/machines/<span class="keyword">default</span>/virtualbox/private_key</span><br></pre></td></tr></table></figure></p><ul><li>若有多个虚拟机，则在ssh 后接名字即可</li></ul><h1 id="Provisioning-预配置"><a href="#Provisioning-预配置" class="headerlink" title="Provisioning 预配置"></a>Provisioning 预配置</h1><p>要使用Preovision 须在Vagrantfile里配置，这样在在虚拟机开启时会自动运行这些预先配置</p><p>配置语法其一为内联<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config<span class="selector-class">.vm</span><span class="selector-class">.provision</span> <span class="string">"shell"</span>, inline: <span class="string">"echo hello"</span></span><br></pre></td></tr></table></figure></p><ul><li><code>config.vm.provision</code> 后接的是预配置的提供者类型 </li></ul><p>其二以配置块的方式出现<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">config.vm.provision <span class="string">"shell"</span> <span class="built_in">do</span> |<span class="type">s</span>|<span class="type"></span></span><br><span class="line"><span class="type">  s</span>.inline = <span class="string">"echo hello"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">或先为其起个名字</span><br><span class="line"> config.vm.provision <span class="string">"ansibbbble"</span>,type: <span class="string">"ansible"</span>  <span class="built_in">do</span> |<span class="type">ansible</span>|<span class="type"></span></span><br><span class="line"><span class="type">  ansible</span>.playbook = <span class="string">"./playbook.yml"</span></span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure></p><ul><li>后者的”ansibbbble” 则为预配置的一个名字，这样的话输出会更加直白</li></ul><p>若是在启动后还想再次运行预配置<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vagrant provision</span></span><br></pre></td></tr></table></figure></p><h1 id="同步文件"><a href="#同步文件" class="headerlink" title="同步文件"></a>同步文件</h1><p>在虚拟机开启时，会自动将当前目录与虚拟机中的 <code>/vagrant</code> 文件夹进行同步，实则自动将当前目录挂载了</p><hr><p><a href="https://www.vagrantup.com/docs/" target="_blank" rel="noopener">更多文档</a></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="vagrant" scheme="http://yoursite.com/tags/vagrant/"/>
    
  </entry>
  
  <entry>
    <title>多进程shell的使用</title>
    <link href="http://yoursite.com/2020/05/01/%E5%A4%9A%E8%BF%9B%E7%A8%8Bshell%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2020/05/01/%E5%A4%9A%E8%BF%9B%E7%A8%8Bshell%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2020-05-01T10:55:28.000Z</published>
    <updated>2020-05-01T12:26:20.008Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>在正常情况下，shell执行一个命令都是fork一个子进程再exec相应命令</p><p>shell也可以实现多进程实现并发</p><p>将要用到多进程的语句用<code>{  }</code>括起来，在最后加上<code>&amp;</code>，就会在运行时运行多个子shell实现多进程</p><p>上面就类似于c语言中的<code>fork()</code>,那不得不说与之搭配的<code>wait（）</code>，shell里对应的是<code>wait</code></p><ul><li><code>wait</code> 默认是等待子进程全部退出，后接pid则为等待指定进程退出</li></ul><p>来一个批量ping的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> &#123;1..254&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    sleep 3</span><br><span class="line">    ping 192.168.1.<span class="variable">$ip</span> -c 3 &gt; /dev/null</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ];</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        hostname=`nslookup 192.168.1.<span class="variable">$ip</span> | awk <span class="string">'&#123;print $4&#125;'</span>`</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$hostname</span> != <span class="string">"find"</span> ]; <span class="comment">#当没找到hostname时为“find”</span></span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"192.168.1.<span class="variable">$ip</span> <span class="variable">$hostname</span> is up"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"192.168.1.<span class="variable">$ip</span> is up"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;&amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">wait</span></span><br></pre></td></tr></table></figure></p><ul><li>使用<code>ps aux | grep ping | grep -v grep | wc -l</code>来验证，结果为254，也就是实实在在有254个进程在并发实行</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="shell" scheme="http://yoursite.com/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>manjaro解决xbox手柄蓝牙问题</title>
    <link href="http://yoursite.com/2020/05/01/manjaro%E4%B8%8B%E8%A7%A3%E5%86%B3%E8%93%9D%E7%89%99%E9%97%AE%E9%A2%98/"/>
    <id>http://yoursite.com/2020/05/01/manjaro%E4%B8%8B%E8%A7%A3%E5%86%B3%E8%93%9D%E7%89%99%E9%97%AE%E9%A2%98/</id>
    <published>2020-05-01T02:58:05.000Z</published>
    <updated>2020-05-01T03:52:07.558Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>安装依赖<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">sudo</span> pacman -S dkms linux-headers <span class="keyword">bluez </span><span class="keyword">bluez-utils</span></span><br></pre></td></tr></table></figure></p><p>查看内核是否加载了蓝牙模块<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep btusb</span><br><span class="line"></span><br><span class="line">&gt;</span><br><span class="line">btusb                  <span class="number">65536</span>  <span class="number">0</span></span><br><span class="line">btrtl                  <span class="number">24576</span>  <span class="number">1</span> btusb</span><br><span class="line">btbcm                  <span class="number">16384</span>  <span class="number">1</span> btusb</span><br><span class="line">btintel                <span class="number">28672</span>  <span class="number">1</span> btusb</span><br><span class="line">bluetooth             <span class="number">671744</span>  <span class="number">39</span> btrtl,btintel,btbcm,bnep,btusb,rfcomm</span><br></pre></td></tr></table></figure></p><p>安装驱动<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="string">/tmp</span></span><br><span class="line">git clone https:<span class="string">//github.com/atar-axis/xpadneo.git</span></span><br><span class="line"><span class="keyword">cd</span> xpadneo </span><br><span class="line">sudo <span class="string">.install.sh</span></span><br></pre></td></tr></table></figure></p><p>此时连接蓝牙<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bluetoothctl</span><br><span class="line"></span><br><span class="line">&gt;scan</span><br><span class="line"><span class="comment"># 此时会出现新扫描出来的设备 </span></span><br><span class="line">[NEW] Device C8:3F:2A:7A:FB:4A Xbox<span class="built_in"> Wireless </span>Controller</span><br><span class="line"></span><br><span class="line">&gt;pair mac地址</span><br><span class="line">&gt;trust mac地址</span><br><span class="line">&gt;connect mac地址</span><br></pre></td></tr></table></figure></p><ul><li>当手柄震动且西瓜灯常亮就应经连接成功了</li></ul><hr><p>关于蓝牙耳机连接上了，但播放没有声音，重启一下服务可以解决<code>systemctl restart bluetooth</code></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="蓝牙" scheme="http://yoursite.com/tags/%E8%93%9D%E7%89%99/"/>
    
  </entry>
  
  <entry>
    <title>周年事记</title>
    <link href="http://yoursite.com/2020/04/25/%E5%91%A8%E5%B9%B4%E4%BA%8B%E8%AE%B0/"/>
    <id>http://yoursite.com/2020/04/25/%E5%91%A8%E5%B9%B4%E4%BA%8B%E8%AE%B0/</id>
    <published>2020-04-25T03:56:14.000Z</published>
    <updated>2020-05-06T14:04:13.014Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><blockquote><p>本来觉得摆脱标签活出自己就已经是尽力了,可渐渐却在追求自我的路上不断给自己加上标签,真像一头猪啊</p></blockquote><p>始终忘不了之前看过的一部电影,镜头先是一个喧闹的酒吧,人们在快活地跳着舞,随着是一个黑白的、无声音的、人们在地上诡异地扭动的上帝视角长镜头。那几分钟，仿佛是一个自我的觉醒</p><blockquote><p>一个无限遥远的目标不是目标,而是一个欺骗<br>  一个无限遥远的理由也不是理由,而是一个借口</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>为多个代理设置反向代理</title>
    <link href="http://yoursite.com/2020/04/19/%E4%B8%BA%E5%A4%9A%E4%B8%AA%E4%BB%A3%E7%90%86%E8%AE%BE%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"/>
    <id>http://yoursite.com/2020/04/19/%E4%B8%BA%E5%A4%9A%E4%B8%AA%E4%BB%A3%E7%90%86%E8%AE%BE%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/</id>
    <published>2020-04-19T14:06:57.000Z</published>
    <updated>2020-04-26T04:36:11.789Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="为web设置反向代理"><a href="#为web设置反向代理" class="headerlink" title="为web设置反向代理"></a>为web设置反向代理</h1><p>首先在http下加上upstream字段<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream webserver &#123;</span><br><span class="line">   <span class="built_in"> server </span>127.0.0.1:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>再在<code>server</code>加上location<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">location</span> <span class="title">/ &#123;</span></span><br><span class="line"><span class="title">    proxy_pass</span> http://webserver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>至此简单反向代理完成<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">upstream</span> web &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:80</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://web;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><p>为的就是实现优化资源利用率,增大吞吐量,减少访问延迟及一定的容错策略</p><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><ul><li>轮询(round-robin) – 对应用程序服务器的请求以轮询方式分发，</li><li>最少的连接(least-connected) – 下一个请求分配给连接最少的服务器</li><li>ip-hash – 根据ip来决定由哪一台服务器</li></ul><p>就上一节来说,当<code>upstram</code>里出现多个<code>server</code>时,默认就为轮询<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在这里加上关键字`weight`可为轮询加上权重</span></span><br><span class="line">    upstream web &#123;</span><br><span class="line">       <span class="built_in"> server </span>127.0.0.1:80 weight = 1;</span><br><span class="line">       <span class="built_in"> server </span>127.0.0.1:81 weight = 10;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><ul><li>意思为11个连接中10个分给81端口,剩下1个给80</li></ul><p>设置<code>least-connected</code>加上<code>minimum_conn</code>即可</p><p>设置<code>ip-hash</code>可实现会话的持久性,以避免重复建立不必要的连接,加上<code>ip_hash</code>即可</p><p><code>upstream</code>的一些高级字段:</p><ul><li>down：表示单前的server暂时不参与负载.</li><li>max_fails：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误.</li><li>fail_timeout : max_fails次失败后，暂停的时间。</li><li>backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。</li></ul><p><a href="http://nginx.org/en/docs/http/load_balancing.html" target="_blank" rel="noopener">http://nginx.org/en/docs/http/load_balancing.html</a></p><h1 id="为多个代理设置反向代理"><a href="#为多个代理设置反向代理" class="headerlink" title="为多个代理设置反向代理"></a>为多个代理设置反向代理</h1><blockquote><p>为什么需要这个?总有些代理不够稳定,这样就需要频繁更改应用的代理端口,如果能设置一个反向代理代理它们,就能以一个固定端口访问了</p></blockquote><p>这里用到的是<code>stream</code>模块而不是<code>http</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream proxys &#123;</span><br><span class="line">       <span class="built_in"> server </span>127.0.0.1:1234 <span class="attribute">max_fails</span>=2 <span class="attribute">fail_timeout</span>=1s;</span><br><span class="line">       <span class="built_in"> server </span>127.0.0.1:12345 backup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> server </span>&#123;</span><br><span class="line">        listen 127.0.0.1:12666;</span><br><span class="line">        # 不能出现server_name字段和其余默认http相关字段</span><br><span class="line"></span><br><span class="line">        proxy_pass proxys;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>这样就ok了,默认优先提供1234端口服务,除非服务不可用超时</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="nginx" scheme="http://yoursite.com/tags/nginx/"/>
    
      <category term="反向代理" scheme="http://yoursite.com/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>docker-compose学习</title>
    <link href="http://yoursite.com/2020/04/12/docker-compose%E5%AD%A6%E4%B9%A0/"/>
    <id>http://yoursite.com/2020/04/12/docker-compose%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-04-12T13:13:55.000Z</published>
    <updated>2020-05-01T12:29:07.032Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="构建自己的镜像"><a href="#构建自己的镜像" class="headerlink" title="构建自己的镜像"></a>构建自己的镜像</h1><p>创建自己的docker镜像可以有两种方式</p><ol><li>在已有镜像上做修改再commit</li><li>利用dockerfile构建</li><li>手动导入导出（过时）</li></ol><h4 id="docker-commit"><a href="#docker-commit" class="headerlink" title="docker commit"></a>docker commit</h4><p>默认容器启动时是在一个可以修改的最顶层镜像层上保存着所有修改的内容，然后重启失效</p><p>可用<code>docker commit -a &quot;作者&quot; -m &quot;描述信息&quot; id 新的镜像名:tag</code> 来将修改的内容保存形成一个新的镜像</p><p>用<code>docker histiry id</code> 查看历史记录</p><p>用<code>docker diff id</code> 查看文件变动</p><p>每次调用<code>commit</code>都会使镜像新增一个新的存储层,哪怕是添加文件后又删除,而每一次操作都是黑箱式操作,不利于维护,所以构建镜像应该用<code>dockerfile</code>来构建</p><h4 id="dockerfile"><a href="#dockerfile" class="headerlink" title="dockerfile"></a>dockerfile</h4><p>dockerfile是一个文本文件,包含了构建docker镜像的指令,每一个指令都会形成一个新的镜像层</p><p><strong>FROM</strong> 用于指定基础镜像</p><ul><li>基础镜像可以是一个服务(mysql)也可以是一个操作系统(alpine 一个非常轻量的linux发行版,仅占5MB左右)</li><li>也可以不指定基础镜像,直接从二进制文件开始作为第一层镜像,需用到<code>FROM scratch</code>，代表的是一个空镜像，然后执行命令</li></ul><p><strong>COPY</strong> 复制文件</p><ul><li>格式为 <code>COPY 源地址 目的地址</code> ，复制完成后会形成一层新的镜像层，相对于一条指令形成一层镜像层</li><li>复制时默认保留文件的元数据，即权限、时间等，也可以手动指定用户和用户组 <code>COPY --chown=user：group 123 123</code></li></ul><p><strong>RUN</strong> 执行命令<br>一共有两种执行格式：</p><ul><li>shell： <code>RUN echo $SHELL</code> 后接一条shell语句或用 <code>&amp;&amp;</code> 拼接的多条语句（这是因为多条指令会多形成新的层，镜像层有最大层数限制且不利于维护，不美观）</li><li>exec： <code>RUN [&quot;echo&quot;,&quot;$SHELL&quot;]</code> 前面为可执行文件，后面为可选的参数</li></ul><p><strong>CMD</strong> 容器启动命令</p><ul><li>格式与<code>RUN</code> 类似</li><li>shell格式的命令会被解析为<code>sh -c command</code>格式，实际为`RUN [“sh”,”-c”,”command”],所以在命令中可用环境变量</li><li>在运行容器时可手动覆盖<code>CMD</code>，如<code>docker run -it test /bin/bsah</code>，镜像名后接的命令即是覆盖后的命令</li><li>需要注意一点，容器提供服务的只是一个进程，容器的1号进程为自己指定的程序，所以当进程退出了容器随即消亡，容器没有后台服务的概念，如果将<code>CMD</code>设置为一个shell命令，那么就是执行完命令容器就退出了，要让容器持续提供服务，<code>CMD</code>应为一个长久的前台命令，如<code>CMD [&quot;nginx&quot;,&quot;-g&quot;,&quot;daemon off&quot;]</code></li></ul><p><strong>ENTRYPOINT</strong> 入口点</p><ul><li>格式与<code>CMD</code>相似，同时也是启动命令</li><li>当<code>CMD</code>和<code>ENTRYPOINT</code>同时出现时（上面说道，），<code>CMD</code>的意义就发生了变化，不再是容器启动命令，而被当作<code>ENTRYPOINT</code>所指定的命令的参数</li><li>和<code>CMD</code>一样可以被覆盖，<code>docker run</code>使用<code>--entrypoint command</code> </li><li>[有点绕&gt;&gt;&gt;&gt;例子]（<a href="https://vuepress.mirror.docker-practice.com/image/dockerfile/entrypoint.html）" target="_blank" rel="noopener">https://vuepress.mirror.docker-practice.com/image/dockerfile/entrypoint.html）</a></li></ul><p><strong>ENV</strong> 环境变量</p><ul><li><code>ENV key value</code> 或者 <code>ENV key=value</code></li><li>设置完的变量在其他指令里也可以用</li><li>同样也可以被覆盖，<code>docker run</code> + <code>-e key=value</code></li></ul><p><strong>VOLUME</strong> 定义匿名卷</p><ul><li>格式与<code>CMD</code>类似，<code>VOLUME /PATH</code>或<code>VOLUME [&quot;PATH&quot;,&quot;PATH2&quot;]</code> </li><li>这里的匿名卷可以将数据库的数据存储下来不至于丢失，但为了方便管理还是手动创建命名良好的卷再挂载，<code>docker run</code> + <code>-v volumename：/path</code></li></ul><p><strong>EXPOSE</strong> 声明端口</p><ul><li>格式类似与上面</li><li>该指令只是声明端口，不会实际开启这个端口提供服务，为<code>docker run</code>命令中指定了<code>-P</code> 的容器端口，然后映射为随机主机端口</li></ul><p><strong>WORKDIR</strong> 指明工作目录</p><ul><li>格式 <code>WORKDIR /PATH</code>，若目录会存在会自动创建</li><li>每一层镜像层都是一个独立环境，上一个切换目录的指令不会影响到下条指令，所以需要指定工作目录</li></ul><p><strong>USER</strong> 指定当前用户</p><ul><li>同上</li></ul><h1 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h1><p><del>咕咕咕,待更新</del></p><h3 id="yaml"><a href="#yaml" class="headerlink" title="yaml"></a>yaml</h3><p><a href="https://www.runoob.com/w3cnote/yaml-intro.html" target="_blank" rel="noopener">yaml入门</a></p><blockquote><p>基本语法</p><ul><li>大小写敏感</li><li>使用缩进表示层级关系</li><li>缩进不允许使用tab，只允许空格</li><li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li><li>‘#’表示注释</li></ul></blockquote><p>YAML 支持以下几种数据类型：</p><ul><li>对象：键值对的集合，又称为映射（mapping）/ 哈希（hashes） / 字典（dictionary）</li><li>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</li><li>标量（scalars）：单个的、不可再分的值</li></ul><p>&amp; 用来建立锚点（defaults），&lt;&lt; 表示合并到当前数据，* 用来引用锚点<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">defaults</span>: &amp;defaults</span><br><span class="line">  <span class="attribute">adapter</span>:  postgres</span><br><span class="line">  <span class="attribute">host</span>:     localhost</span><br><span class="line"></span><br><span class="line"><span class="attribute">development:</span></span><br><span class="line">  database: myapp_development</span><br><span class="line">  &lt;&lt;: *defaults</span><br><span class="line"></span><br><span class="line"><span class="attribute">test:</span></span><br><span class="line">  database: myapp_test</span><br><span class="line">  &lt;&lt;: *defaults</span><br></pre></td></tr></table></figure></p><ul><li><code>&lt;&lt;: *defaults</code> == <code>adapter: postgres \n host: localhost</code></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
      <category term="容器" scheme="http://yoursite.com/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>使用ufw配置防火墙</title>
    <link href="http://yoursite.com/2020/04/06/%E4%BD%BF%E7%94%A8ufw%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    <id>http://yoursite.com/2020/04/06/%E4%BD%BF%E7%94%A8ufw%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99/</id>
    <published>2020-04-06T12:33:04.000Z</published>
    <updated>2020-04-25T02:22:04.664Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><blockquote><p>iptables 是一个命令行实用工具，用于配置 Netfilter 项目中实现的 Linux 内核防火墙。 术语 iptables 也通常用来指这种内核级别的防火墙。 它可以直接用 iptables 进行配置，或者使用许多控制台和图形前端之一进行配置。</p></blockquote><p>这次要讲到的ufw是 Uncomplicated Firewall 的缩写，是一个管理 netfilter 防火墙的程序。 它提供了一个命令行界面，目的是简单易用</p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>为命令行模式<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pacman -S ufw</span></span><br></pre></td></tr></table></figure></p><p>也有图形的<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pacman -S gufw</span></span><br></pre></td></tr></table></figure></p><h1 id="状态查询"><a href="#状态查询" class="headerlink" title="状态查询"></a>状态查询</h1><p>启用它<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure></p><ul><li>这样就会开机启动了</li><li>注意不能和<code>iptables.service</code>同时启用</li></ul><p>关闭    <code>ufw disable</code></p><p>查看状态    <code>ufw status</code></p><p>查看状态，规则以数字标号    <code>ufw status numbered</code></p><ul><li>后面删除规则就会用到规则号码</li></ul><h1 id="规则语法"><a href="#规则语法" class="headerlink" title="规则语法"></a>规则语法</h1><h3 id="具体的地址端口"><a href="#具体的地址端口" class="headerlink" title="具体的地址端口"></a>具体的地址端口</h3><p>允许任意来源任意协议放开53端口  <code>ufw allow 53</code></p><ul><li>会增加两条规则，分别对应v4、v6</li><li>在端口号后可指定协议，如<code>53/tcp</code></li></ul><p>而对应完整版应为<code>来源/目的+端口</code>    </p><ul><li><code>ufw allow proto tcp from any to any port 53</code></li><li><code>ufw allow proto udp from any to any port 53</code></li></ul><p>前面的语句默认是放开、拒绝双向连接，也可以指定单向</p><ul><li><code>ufw allow in 53</code></li><li><code>ufw allow out 53</code></li></ul><p>可以同时指定多个端口    <code>ufw allow proto tcp from any to any port 80,443,8080:8090</code></p><ul><li>不能单独删除一个端口</li><li>端口间不能接空格</li></ul><p>any指带的即是网络号，也可以是设备</p><ul><li>如<code>ufw deny proto tcp from 10.0.0.0/8 to 192.168.0.1 port 53</code></li><li>拒绝来自10.0.0.0/8域的tcp协议指向192.168.0.1端口53的数据进入本机</li><li><code>ufw route allow in on eth1 out on eth2</code></li><li>允许经eth1进入，eth2发出的数据经本机路由</li></ul><p>删除规则    <code>ufw delete allow 53</code></p><ul><li>或者通过规则序号删除  <code>ufw delete num</code></li></ul><h3 id="app-profiles"><a href="#app-profiles" class="headerlink" title="app profiles"></a>app profiles</h3><p>默认自带app配置在<code>/etc/ufw/applications.d/</code></p><ul><li>或通过<code>ufw app list</code>查看名字，再<code>ufw app info name</code><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ufw app <span class="builtin-name">info</span> WWW</span><br><span class="line"></span><br><span class="line">&gt;</span><br><span class="line">Profile: WWW</span><br><span class="line">Title: Web Server</span><br><span class="line">Description: Web server</span><br><span class="line"></span><br><span class="line">Port:</span><br><span class="line">80/tcp</span><br></pre></td></tr></table></figure></li></ul><p>添加删除规则直接用app名字来进行</p><ul><li>添加  <code>ufw allow WWW</code></li><li>删除  <code>ufw delete allow WWW</code></li></ul><p>添加一个新的app配置<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ufw/applications.d/ufw-kde-connect</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关键字全部加上缺一不可</span></span><br><span class="line">[kde-connect]   <span class="comment">#app配置名</span></span><br><span class="line">title=kde-connect</span><br><span class="line">description=kde-connect</span><br><span class="line">ports=1716  <span class="comment">#规则</span></span><br></pre></td></tr></table></figure></p><ul><li>更新使其生效  <code>ufw app update kde-connect</code></li><li>这样通过app名管理更加直观</li></ul><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>在测试时发现通过docker暴露出来的端口不受ufw控制</p><ul><li><a href="https://blog.csdn.net/sinat_33384251/article/details/94409846" target="_blank" rel="noopener">解决方案</a></li></ul><hr><p>ref:<br><a href="https://wiki.manjaro.org/index.php?title=Firewalls" target="_blank" rel="noopener">https://wiki.manjaro.org/index.php?title=Firewalls</a><br><a href="https://wiki.ubuntu.org.cn/Ufw%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97" target="_blank" rel="noopener">https://wiki.ubuntu.org.cn/Ufw%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97</a></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
      <category term="ufw" scheme="http://yoursite.com/tags/ufw/"/>
    
      <category term="iptables" scheme="http://yoursite.com/tags/iptables/"/>
    
  </entry>
  
  <entry>
    <title>linux 命令杂记</title>
    <link href="http://yoursite.com/2020/04/01/linux-%E5%91%BD%E4%BB%A4%E6%9D%82%E8%AE%B0/"/>
    <id>http://yoursite.com/2020/04/01/linux-%E5%91%BD%E4%BB%A4%E6%9D%82%E8%AE%B0/</id>
    <published>2020-04-01T14:48:57.000Z</published>
    <updated>2020-04-25T02:22:04.664Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h1><p>根据某个字符串，查询该字符串前后文本信息命令：grep-A|B n”key”file</p><p>其中：<br>    A：表示在字符串之后 after  context<br>    B：表示在字符串之前 before context<br>    n：要获取多少行文本 line number</p><p>实例：grep -A 100 -B 100 -i ‘111’ catalina.out</p><ul><li>-i表示忽略大小写。</li></ul><p>当然，如果我们想获取异常日志的前10行和后10行，不用加-A和-B，使用如下命令就可以了：</p><ul><li>实例：grep -10 -i ‘111’ catalina.out</li></ul><h1 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h1><p>mke2fs -t ext4 /dev/name</p><p>mkfs<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkfs           mkfs<span class="selector-class">.cramfs</span>    mkfs<span class="selector-class">.ext3</span>      mkfs<span class="selector-class">.hfs</span>       mkfs<span class="selector-class">.minix</span>     mkfs.reiserfs</span><br><span class="line">mkfs<span class="selector-class">.bfs</span>       mkfs<span class="selector-class">.exfat</span>     mkfs<span class="selector-class">.ext4</span>      mkfs<span class="selector-class">.hfsplus</span>   mkfs<span class="selector-class">.msdos</span>     mkfs<span class="selector-class">.vfat</span>    </span><br><span class="line">mkfs<span class="selector-class">.btrfs</span>     mkfs<span class="selector-class">.ext2</span>      mkfs<span class="selector-class">.fat</span>       mkfs<span class="selector-class">.jfs</span>       mkfs<span class="selector-class">.ntfs</span>      mkfs.xfs</span><br></pre></td></tr></table></figure></p><h3 id="备份数据"><a href="#备份数据" class="headerlink" title="备份数据"></a>备份数据</h3><p>rsync </p><blockquote><p>  Transfer files either to or from a remote host (not between two remote hosts).<br>  Can transfer single files, or multiple files matching a pattern.</p><ul><li>可用来转移数据,传输文件</li></ul></blockquote><p><code>rsync -av</code>原地址 目的地址</p><ul><li>a包含文件所有信息(This is equivalent to -rlptgoD),如原本权限,修改时间,子目录等等</li><li>v为显示传输过程,P为更为详细的信息输出</li></ul><p>既可以拉取数据,也可以发送数据<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Pull</span>: <span class="selector-tag">rsync</span> <span class="selector-attr">[OPTION...]</span> <span class="selector-attr">[USER@]</span><span class="selector-tag">HOST</span><span class="selector-pseudo">:SRC...</span> <span class="selector-attr">[DEST]</span></span><br><span class="line"><span class="selector-tag">Push</span>: <span class="selector-tag">rsync</span> <span class="selector-attr">[OPTION...]</span> <span class="selector-tag">SRC</span>... <span class="selector-attr">[USER@]</span><span class="selector-tag">HOST</span><span class="selector-pseudo">:DEST</span></span><br></pre></td></tr></table></figure></p><h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><p>查看分区信息<br><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fdisk</span> <span class="string">-l</span></span><br><span class="line"></span><br><span class="line"><span class="attr">df</span> <span class="string">-h</span></span><br></pre></td></tr></table></figure></p><p>具体分区操作<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fdisk /dev/设备名</span><br><span class="line"></span><br><span class="line"><span class="symbol">:p</span>  查看设备分区情况</span><br><span class="line"><span class="symbol">:F</span>  查看设备未分区的块</span><br><span class="line"><span class="symbol">:d</span>  删除一个分区</span><br><span class="line"><span class="symbol">:n</span>  建立一个分区</span><br></pre></td></tr></table></figure></p><ul><li>创建完分区记得创建文件系统</li></ul><h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><p>resize2fs   /dev/mapper/cl00-root  </p><h3 id="swap"><a href="#swap" class="headerlink" title="swap"></a>swap</h3><p><a href="https://www.cnblogs.com/FengGeBlog/p/10239067.html" target="_blank" rel="noopener">https://www.cnblogs.com/FengGeBlog/p/10239067.html</a></p><h3 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h3><p>开机自动挂载需修改<code>/etc/fstab</code></p><h3 id="uuid"><a href="#uuid" class="headerlink" title="uuid"></a>uuid</h3><p>blkid /dev/name</p><h1 id="grub"><a href="#grub" class="headerlink" title="grub"></a>grub</h1><p>quit 为简单输出<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">GRUB_CMDLINE_LINUX_DEFAULT</span>=<span class="string">"quiet splash"</span></span><br></pre></td></tr></table></figure></p><ul><li>为默认启动内核参数,一直有效(包括救援模式)</li><li>splash 为显示linux发行版logo</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">GRUB_CMDLINE_LINUX</span>=</span><br></pre></td></tr></table></figure><ul><li>为救援模式的启动参数</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/etc/</span><span class="keyword">default</span>/grub</span><br><span class="line">update-grub</span><br></pre></td></tr></table></figure><p>或在开机出现logo前按ESC再按e可修改启动参数(本次启动有效)</p><h1 id="brightness"><a href="#brightness" class="headerlink" title="brightness"></a>brightness</h1><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo </span><span class="string">systemctl </span><span class="built_in">list-units</span> | <span class="string">grep </span><span class="string">backlight</span></span><br></pre></td></tr></table></figure><ul><li>发现一个启动失败,可能是发生了冲突</li></ul><p>禁用其一<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl mask systemd-backlight<span class="meta">@backlight</span>:acpi_video0.service </span><br><span class="line">Created symlink <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>systemd-backlight<span class="meta">@backlight</span>:acpi_video0.service → <span class="regexp">/dev/</span></span><br><span class="line"><span class="literal">null</span>.</span><br></pre></td></tr></table></figure></p><p>重启另外一个<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart systemd-backlight<span class="variable">@backlight</span><span class="symbol">:nvidia_0</span>.service</span><br></pre></td></tr></table></figure></p><ul><li>重启机器发现亮度已经可以正常恢复</li></ul><h1 id="启动时间"><a href="#启动时间" class="headerlink" title="启动时间"></a>启动时间</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemd-<span class="keyword">analyze</span>  </span><br><span class="line"></span><br><span class="line">systemd-<span class="keyword">analyze</span> blame</span><br><span class="line"></span><br><span class="line">systemd-<span class="keyword">analyze</span> <span class="keyword">critical</span>-<span class="keyword">chain</span></span><br></pre></td></tr></table></figure><ul><li>可以根据以上命令输出关闭一些不常用服务以加速开机 `systemctl mask(disable)</li><li>有些服务需要用但就是慢可以尝试手动修改 <code>服务名.service</code>文件,将其加上<code>After = graphical.target</code>,也就是在先等桌面加载玩再加载服务</li></ul><h1 id="zabbix"><a href="#zabbix" class="headerlink" title="zabbix"></a>zabbix</h1><h3 id="NAT转换"><a href="#NAT转换" class="headerlink" title="NAT转换"></a>NAT转换</h3><p>在虚拟机上部署zabbix时,虚拟机使用了NAT网桥,<code>telnet</code>能通,当server一直连不上</p><ul><li>最后在agent配置文件上server的地址加上网关地址<br><a href="https://sysadmin.xyz/main/2018/01/08/zabbix-nat-problem/" target="_blank" rel="noopener">https://sysadmin.xyz/main/2018/01/08/zabbix-nat-problem/</a></li></ul><h3 id="snmp"><a href="#snmp" class="headerlink" title="snmp"></a>snmp</h3><p>安装使用</p><ul><li><a href="http://www.net-snmp.org/wiki/index.php/Tutorials" target="_blank" rel="noopener">http://www.net-snmp.org/wiki/index.php/Tutorials</a></li><li><a href="https://blog.csdn.net/bbwangj/article/details/80981098" target="_blank" rel="noopener">https://blog.csdn.net/bbwangj/article/details/80981098</a></li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">telnet 192.168.1.1 161<span class="built_in"> Connection </span>refused</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定用udp扫描端口161</span></span><br><span class="line">nmap -sU 192.168.1.1 -p161</span><br></pre></td></tr></table></figure><h1 id="lol安装"><a href="#lol安装" class="headerlink" title="lol安装"></a>lol安装</h1><p><a href="https://www.reddit.com/r/leagueoflinux/comments/alfbep/league_on_linux_mint_19/" target="_blank" rel="noopener">https://www.reddit.com/r/leagueoflinux/comments/alfbep/league_on_linux_mint_19/</a></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> snapd</span><br><span class="line"></span><br><span class="line">snap <span class="keyword">install</span> leagueoflegends <span class="comment">--edge --devmode</span></span><br></pre></td></tr></table></figure><ul><li><p>很简单粗暴,没有国服</p></li><li><p>Please consider using the Nouveau driver instead.<br><a href="https://askubuntu.com/questions/267936/how-do-i-get-rid-of-broken-nvidia-randr-detected-falling-back-to-randr-1-0" target="_blank" rel="noopener">https://askubuntu.com/questions/267936/how-do-i-get-rid-of-broken-nvidia-randr-detected-falling-back-to-randr-1-0</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="linxu" scheme="http://yoursite.com/tags/linxu/"/>
    
  </entry>
  
  <entry>
    <title>zabbix折腾记-安装篇</title>
    <link href="http://yoursite.com/2020/03/26/zabbix%E6%8A%98%E8%85%BE%E8%AE%B0/"/>
    <id>http://yoursite.com/2020/03/26/zabbix%E6%8A%98%E8%85%BE%E8%AE%B0/</id>
    <published>2020-03-26T12:51:08.000Z</published>
    <updated>2020-04-25T02:22:04.664Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h1><p>要想服务跑起来看得见,就得安装自身服务端,MySQL,前端</p><h3 id="服务端安装"><a href="#服务端安装" class="headerlink" title="服务端安装"></a>服务端安装</h3><p><a href="https://www.zabbix.com/documentation/current/manual/installation/install" target="_blank" rel="noopener">添加用户组</a><br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addgroup --system --quiet zabbix</span><br><span class="line">adduser --quiet --system --disabled-login --ingroup zabbix --home /var/<span class="class"><span class="keyword">lib</span>/<span class="title">zabbix</span> --<span class="title">no</span>-<span class="title">create</span>-<span class="title">home</span> <span class="title">zabbix</span></span></span><br></pre></td></tr></table></figure></p><p><a href="https://www.zabbix.com/cn/download_sources#tab:40LTS" target="_blank" rel="noopener">下载地址</a><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看编译的一些功能选项</span></span><br><span class="line"><span class="string">./configure</span> <span class="params">--help</span></span><br><span class="line"></span><br><span class="line"><span class="string">./configure</span> <span class="params">--prefix=/usr/local/zabbix</span> <span class="params">--enable-server</span> <span class="params">--enable-agent</span> <span class="params">--enable-java</span> </span><br><span class="line"><span class="params">--with-mysql</span> <span class="params">--with-libxml2</span> <span class="params">--with-unixodbc</span> <span class="params">--with-net-snmp</span> <span class="params">--with-ssh2</span>  <span class="params">--with-libcurl</span> <span class="params">--with-iconv</span></span><br><span class="line"></span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p><h5 id="依赖问题"><a href="#依赖问题" class="headerlink" title="依赖问题"></a>依赖问题</h5><ul><li>MySQL library not found <code>sudo apt install libmysqlclient-dev</code></li><li>unixODBC <code>sudo apt install unixodbc-dev</code></li><li>configure error: Invalid Net-SNMP directory - unable to find net-snmp-config <code>sudo apt install libsnmp-dev</code></li><li>error: SSH2 library not found  <code>sudo apt install libssh2-1-dev</code></li><li>Unable to find “javac” executable in path <code>sudo apt install openjdk-11-jdk</code></li></ul><p>经过大量搜索貌似找到了解决依赖的一个好办法</p><ul><li><code>apt search &#39;*软件名*&#39;</code></li><li>一般安装那个带<code>-dev</code>的就OK了 </li></ul><h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><p>不知道为什么自带软件源安装的mysql、httpd、nginx都用不了，可能是因为用着ubuntu的源，而issue里写的是mint没直接写上基于ubuntu了 ┑(￣Д ￣)┍</p><p>这里还是直接用了docker<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="builtin-name">run</span> -id -name mysql -p3306:3306 -e  <span class="attribute">MYSQL_ROOT_PASSWORD</span>=111111 mysql</span><br></pre></td></tr></table></figure></p><ul><li>不加MYSQL_ROOT_PASSWORD=111111 的话容器都不会开启</li></ul><p><a href="https://www.zabbix.com/documentation/current/manual/appendix/install/db_scripts" target="_blank" rel="noopener">创建数据库</a><br><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; mysql -uroot -p&lt;<span class="keyword">password</span>&gt;</span><br><span class="line">mysql&gt; <span class="keyword">create</span> <span class="keyword">database</span> zabbix <span class="type">character</span> <span class="keyword">set</span> utf8 <span class="keyword">collate</span> utf8_bin;</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'zabbix'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'&lt;password&gt;'</span>;</span><br><span class="line">mysql&gt; <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'zabbix'</span>@<span class="string">'%'</span>;#需要加上这条授权参考下面第一个错误</span><br><span class="line"></span><br><span class="line">shell&gt; cd <span class="keyword">database</span>/mysql</span><br><span class="line">shell&gt; mysql -uzabbix -p&lt;<span class="keyword">password</span>&gt; zabbix &lt; <span class="keyword">schema</span>.<span class="keyword">sql</span></span><br><span class="line"># stop here <span class="keyword">if</span> you are creating <span class="keyword">database</span> <span class="keyword">for</span> Zabbix proxy</span><br><span class="line">shell&gt; mysql -uzabbix -p&lt;<span class="keyword">password</span>&gt; zabbix &lt; images.<span class="keyword">sql</span></span><br><span class="line">shell&gt; mysql -uzabbix -p&lt;<span class="keyword">password</span>&gt; zabbix &lt; data.<span class="keyword">sql</span></span><br></pre></td></tr></table></figure></p><ul><li><a href="https://www.cnblogs.com/B1ackWall/p/11643136.html" target="_blank" rel="noopener">ERROR 1410 (42000): You are not allowed to create a user with GRANT</a></li></ul><ul><li><a href="https://stackoverflow.com/questions/10299148/mysql-error-1045-28000-access-denied-for-user-billlocalhost-using-passw" target="_blank" rel="noopener">MySQL ERROR 1045 (28000): Access denied for user ‘bill‘@’localhost’ (using password: YES)</a></li></ul><ul><li>[Error connecting to database: The server requested authentication method unknow]<br>(<a href="https://learnku.com/articles/10736/some-craters-in-mysql-8011" target="_blank" rel="noopener">https://learnku.com/articles/10736/some-craters-in-mysql-8011</a>)</li></ul><h2 id="php"><a href="#php" class="headerlink" title="php"></a>php</h2><p>前端拿php写的,故需要安装php<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install php7<span class="number">.2</span>-fpm</span><br></pre></td></tr></table></figure></p><p>需要修改默认配置文件以满足zabbix需求<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/php/7.2/fpm/php.ini </span><br><span class="line"></span><br><span class="line">max_execution_time = 300 <span class="comment">##368行（执行时间）</span></span><br><span class="line">max_input_time = 300 <span class="comment">##378行（接收数据等待时间）</span></span><br><span class="line">memory_limit = 128M <span class="comment">##389行（每个脚本占用内存）</span></span><br><span class="line">post_max_size = 16M <span class="comment">##656行（POST数据大小）</span></span><br><span class="line">upload_max_filesize = 2M <span class="comment">##799行（下载文件大小）</span></span><br><span class="line">always_populate_raw_post_data = -1 <span class="comment">##800行</span></span><br><span class="line">date.timezone = Asia/Shanghai <span class="comment">##877行（时区</span></span><br></pre></td></tr></table></figure></p><ul><li>不改的话,后面也不会成功</li></ul><h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><p><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">下载</a></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make <span class="keyword">install</span></span><br></pre></td></tr></table></figure><ul><li><del>配置不太熟还需仔细研究</del></li></ul><p>遇到的一个错误<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[error]</span> <span class="number">16119</span>#<span class="number">0</span>: *<span class="number">75</span> FastCGI sent in stderr: <span class="string">"Primary script unknown"</span> </span><br><span class="line">while reading response header from upstream, client: <span class="number">127.0.0.1</span>, server: localhost, request:</span><br><span class="line"> <span class="string">"<span class="keyword">GET</span> / HTTP/1.1"</span>, upstream: <span class="string">"fastcgi://unix:/run/php/php7.2-fpm.sock:"</span>, host: <span class="string">"127.0.0.1"</span></span><br></pre></td></tr></table></figure></p><ul><li>参考<a href="https://serverfault.com/questions/517190/nginx-1-fastcgi-sent-in-stderr-primary-script-unknown" target="_blank" rel="noopener">这里</a> . 犯了两个错误 :</li></ul><ol><li><code>/etc/php/7.2/fpm/pool.d/www.conf</code>   里设置的用户名和用户组与ngnix运行的不一致</li><li>复制php前端文件时用的是root</li></ol><p>附上简单丑陋的配置<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  localhost;</span><br><span class="line">     index index.php;</span><br><span class="line">     root /<span class="keyword">var</span>/www/php/;</span><br><span class="line"></span><br><span class="line">     location ~* \.php$ &#123;</span><br><span class="line">         <span class="keyword">include</span> fastcgi_params;</span><br><span class="line">         fastcgi_index  index.php;</span><br><span class="line">                     <span class="keyword">include</span>      fastcgi_params;</span><br><span class="line">         <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="string">""</span>; </span><br><span class="line">         <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">         <span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> ~ <span class="string">"^(.+?\.php)(/.+)$"</span>) &#123;</span><br><span class="line">                 <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$1</span>; </span><br><span class="line">                 <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="variable">$2</span>; </span><br><span class="line">         &#125;</span><br><span class="line">         fastcgi_param SCRIPT_FILENAME /<span class="keyword">var</span>/www/php/<span class="variable">$real_script_name</span>;</span><br><span class="line">         fastcgi_param SCRIPT_NAME <span class="variable">$real_script_name</span>;</span><br><span class="line">         fastcgi_param PATH_INFO <span class="variable">$path_info</span>;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//这里默认是127.0.0.1:9000;</span></span><br><span class="line">         <span class="comment">//需要到/etc/php/7.2/fpm/pool.d/www.conf查看监听的地址</span></span><br><span class="line">         fastcgi_pass unix:/<span class="keyword">run</span>/php/php7.2-fpm.sock;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>查看error日志可以快速定位问题</li></ul><h1 id="docker-install"><a href="#docker-install" class="headerlink" title="docker install"></a>docker install</h1><p><a href="https://www.zabbix.com/documentation/current/manual/installation/containers" target="_blank" rel="noopener">源自这里</a><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># docker run --name zabbix-appliance -t \</span><br><span class="line">      -<span class="ruby">p <span class="number">10051</span><span class="symbol">:</span><span class="number">10051</span> \</span></span><br><span class="line"><span class="ruby">      -p <span class="number">80</span><span class="symbol">:</span><span class="number">80</span> \</span></span><br><span class="line"><span class="ruby">      --restart <span class="keyword">unless</span>-stopped \</span></span><br><span class="line"><span class="ruby">      -d zabbix/zabbix-<span class="symbol">appliance:</span>latest</span></span><br></pre></td></tr></table></figure></p><ul><li>开箱可用,十分方便</li></ul><h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>都安装好之后,需要检查/etc/zabbix/zabbix_server.conf里的数据库账号名密码地址是否正确</p><p>需要检查/etc/zabbix/zabbix_agent.conf里server名字地址是否正确</p><p>真香<img src="/images/20200326=0.png" alt></p><p>太香了<img src="/images/20200326=1.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="工具" scheme="http://yoursite.com/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="zabbix" scheme="http://yoursite.com/tags/zabbix/"/>
    
      <category term="监控" scheme="http://yoursite.com/tags/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>flatpak入门指南</title>
    <link href="http://yoursite.com/2020/03/10/flatpak%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/"/>
    <id>http://yoursite.com/2020/03/10/flatpak%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/</id>
    <published>2020-03-10T13:48:18.000Z</published>
    <updated>2020-04-25T02:22:04.661Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>之所以会用到<code>flatpak</code>主要是突然想学学GTK,刚好有个亲生的IDE<code>gnome-builder</code>,安装有点小坑</p><h1 id="flatpak"><a href="#flatpak" class="headerlink" title="flatpak"></a>flatpak</h1><blockquote><p><a href="https://docs.flatpak.org/en/latest/introduction.html" target="_blank" rel="noopener">Flatpak</a> is a framework for distributing desktop applications on Linux. It has been created by developers who have a long history of working on the Linux desktop, and is run as an independent open source project.</p></blockquote><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>几个概念需要了解一下<br><img src="/images/20200310=0.png" alt></p><ul><li>最底层的是我们的操作系统,往上是由不同的仓库所提供的runtime,也就是打包好的依赖项加上软件,这样就能做到安装即使用,不依赖具体的发行版,这个概念类似与<code>snap</code>和<code>.appimage</code>了</li><li>仓库就类似与git里的远程仓库,自带版本控制,可自由升级降级</li><li>对于安装的应用本身是运行在应用独占的沙盒里的,很好的做到了权限的分离,也用不着<code>sudo apt *</code>一把嗦了</li></ul><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>在mint19.2 上已经自带安装了，但默认是不可用的<a href="https://flatpak.org/setup/" target="_blank" rel="noopener">setup</a></p><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>查看当前仓库情况<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">flatpak remotes</span></span><br></pre></td></tr></table></figure></p><p>添加一个新的仓库<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flatpak remote-<span class="built_in">add</span> --<span class="keyword">if</span>-not-<span class="built_in">exists</span> flathub http<span class="variable">s:</span>//<span class="keyword">dl</span>.flathub.org/repo/flathub.flatpakrepo</span><br></pre></td></tr></table></figure></p><ul><li>语法也与git相似,<code>flathub</code>为给仓库取的别名,后面接的是相应url</li><li><code>--if-not-exists</code>防止重复添加相同的仓库</li></ul><p>删除一个仓库<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flatpak remote-<span class="keyword">delete</span> flathub</span><br></pre></td></tr></table></figure></p><p>搜索新的软件<br><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flatpak <span class="keyword">search</span> <span class="type">name</span></span><br></pre></td></tr></table></figure></p><ul><li>将会返回<code>Application ID</code>,<code>Version Branch</code>, <code>Remotes</code>, <code>Description</code>,依次是应用的id(后面安装的时候会用到),版本,仓库别名,描述</li></ul><p>安装卸载新的软件<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flatpak <span class="keyword">install</span> flathub(仓库别名) Application <span class="keyword">ID</span></span><br><span class="line"></span><br><span class="line">flatpak <span class="keyword">uninstall</span> Application <span class="keyword">ID</span></span><br></pre></td></tr></table></figure></p><p>查看已安装软件<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">flatpak lists</span></span><br></pre></td></tr></table></figure></p><p>更新软件<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">flatpak update</span></span><br></pre></td></tr></table></figure></p><p>至此已经可以愉快的玩耍了</p><h1 id="gnome-builder"><a href="#gnome-builder" class="headerlink" title="gnome-builder"></a>gnome-builder</h1><p>抱着多学知识<del>瞎折腾</del>的心态一开始选择了编译源码</p><p>然后成功见识到meson和ninja这套跨平台编译工具<del>下篇见</del>,折腾了一晚上后最终倒在不知名错误上</p><p>尝试自带软件源的gnome-builder又是个半残废,最后使用flatpak安装成功</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flatpak install flathub org<span class="selector-class">.gnome</span><span class="selector-class">.Builder</span></span><br></pre></td></tr></table></figure><h3 id="解决不能使用暗间模式的问题"><a href="#解决不能使用暗间模式的问题" class="headerlink" title="解决不能使用暗间模式的问题"></a>解决不能使用暗间模式的问题</h3><p>由于是基于沙箱运行的程序,导致不能正确识别到自身主题控件,需要单独安装相应黑暗主题</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看主题</span></span><br><span class="line"><span class="attr">neofetch</span> <span class="string">| grep Theme</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索主题</span></span><br><span class="line"><span class="attr">flatpak</span> <span class="string">search name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="attr">flatpak</span> <span class="string">install * *</span></span><br></pre></td></tr></table></figure><p>此时黑暗主题可用</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="工具" scheme="http://yoursite.com/tags/%E5%B7%A5%E5%85%B7/"/>
    
      <category term="flatpak" scheme="http://yoursite.com/tags/flatpak/"/>
    
      <category term="gnome-builder" scheme="http://yoursite.com/tags/gnome-builder/"/>
    
  </entry>
  
  <entry>
    <title>关于c语言中一些疑难点的复习</title>
    <link href="http://yoursite.com/2020/03/07/%E5%85%B3%E4%BA%8Ec%E8%AF%AD%E8%A8%80%E4%B8%AD%E4%B8%80%E4%BA%9B%E7%96%91%E9%9A%BE%E7%82%B9%E7%9A%84%E5%A4%8D%E4%B9%A0/"/>
    <id>http://yoursite.com/2020/03/07/%E5%85%B3%E4%BA%8Ec%E8%AF%AD%E8%A8%80%E4%B8%AD%E4%B8%80%E4%BA%9B%E7%96%91%E9%9A%BE%E7%82%B9%E7%9A%84%E5%A4%8D%E4%B9%A0/</id>
    <published>2020-03-07T12:38:48.000Z</published>
    <updated>2020-04-25T02:22:04.664Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="声明和定义"><a href="#声明和定义" class="headerlink" title="声明和定义"></a>声明和定义</h1><table><thead><tr><th style="text-align:center">声明</th><th style="text-align:center">描述对象的类型,用于指代其他地方定义的对象,如<code>extern int i;</code></th></tr></thead><tbody><tr><td style="text-align:center">定义</td><td style="text-align:center">确定对象的类型并分配类型,用于创建新的对象,如<code>int i ;</code></td></tr></tbody></table><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> i = <span class="number">0</span>;  <span class="comment">// 既是声明也是定义</span></span><br><span class="line">extern <span class="built_in">int</span> i; <span class="comment">// 为声明,表示在其他地方有定义</span></span><br><span class="line">extern <span class="built_in">int</span> i = <span class="number">0</span>; <span class="comment">// 既是声明也是定义</span></span><br></pre></td></tr></table></figure><ul><li>对于函数,结构体同样适用</li></ul><hr><h1 id="指针和数组名一样么"><a href="#指针和数组名一样么" class="headerlink" title="指针和数组名一样么"></a>指针和数组名一样么</h1><p>首先看一个例子<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> pp[]= &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line"><span class="built_in">int</span> * p = pp ;</span><br><span class="line"></span><br><span class="line">printf(<span class="string">"%d %d"</span>,pp[<span class="number">0</span>],p[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">&gt; <span class="number">1</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p><ul><li>毫无疑问,这是没有问题的</li></ul><p>但是如果是这样的呢<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="built_in">int</span> pp[<span class="number">3</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;  <span class="comment">//假设在文件A</span></span><br><span class="line">extern <span class="built_in">int</span> *pp;  <span class="comment">//假设在文件B</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//在文件B中</span></span><br><span class="line">printf(<span class="string">"%d"</span>,pp[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure></p><ul><li>能正确输出<code>1</code>吗,答案是<strong>不能</strong></li><li><code>int pp[]</code>是一个数组,<code>int *pp</code>是一个指针,不能因为变量名一样而将指针和数组名混为一谈</li><li>在<code>int pp[]</code>中,pp代表的是pp这个数组的真实地址,但在<code>int *pp</code>中,pp只是个指针变量,变量的值才为真正所需要访问的地址,在这里犯了类型不匹配的错误</li></ul><p>若要正确使用,在文件B中应该改为<code>extern int pp[]</code></p><p>什么时候数组等同于指针</p><ul><li>出现表达式中时,数组名会被转换为一个指针,如<code>int pp[3] = {0};  *(pp+1) ;</code></li><li>把数组下标作为指针的偏移量,<code>int *p =pp ; *(篇+1);</code></li><li>作为函数的参数</li></ul><hr><h1 id="如何在-main-执行之前先运行其它函数"><a href="#如何在-main-执行之前先运行其它函数" class="headerlink" title="如何在 main() 执行之前先运行其它函数"></a>如何在 main() 执行之前先运行其它函数</h1><p>刚学c语言的时候,相信对main()函数的印象都是它是程序运行时第一个运行的函数,其实不然</p><p>先写个简单小程序<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> agrc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello world!"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>运行编译毫无疑问是<code>Hello world!</code></li></ul><p>先了解一下可执行文件格式<br><img src="/images/20200307=0.png" alt></p><p>其中的<code>.text</code> <code>.data</code> <code>.bss</code> 是不是像极了c语言程序运行时存储空间布局中所对应的</p><ul><li><code>text</code> 保存的是编译后得到的机器码</li><li><code>.rodata</code> 保存是只读数据,如<code>char *buf = &quot;hi&quot;</code>这里的<code>hi</code>为只读的字符串常量</li><li><code>data</code> 保存的是被初始化的全局变量和静态变量</li><li><code>bss</code> 保存的是未初始化的保存的是未被初始化额全局变量和静态变量，及被初始化为0的初始变量</li></ul><p>而这里想看是<code>.systab</code>保存的是在程序中定义或者引用的函数、全局变量<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf - Displays information about ELF files.</span></span><br><span class="line"></span><br><span class="line">readelf -s a.out</span><br><span class="line"></span><br><span class="line"> &gt;    2: 0000000000000000     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span> UND puts@GLIBC_2.2.5 (2)</span><br><span class="line">     3: 0000000000000000     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span> UND __libc_start_main@GLIBC_2.2.5 (2)</span><br><span class="line">     6: 0000000000000000     0 FUNC    WEAK  <span class="built_in"> DEFAULT </span> UND __cxa_finalize@GLIBC_2.2.5 (2)</span><br><span class="line">    27: 0000000000000560     0 FUNC    LOCAL <span class="built_in"> DEFAULT </span>  14 deregister_tm_clones</span><br><span class="line">    28: 00000000000005a0     0 FUNC    LOCAL <span class="built_in"> DEFAULT </span>  14 register_tm_clones</span><br><span class="line">    29: 00000000000005f0     0 FUNC    LOCAL <span class="built_in"> DEFAULT </span>  14 __do_global_dtors_aux</span><br><span class="line">    32: 0000000000000630     0 FUNC    LOCAL <span class="built_in"> DEFAULT </span>  14 frame_dummy</span><br><span class="line">    43: 00000000000006d0     2 FUNC    GLOBAL<span class="built_in"> DEFAULT </span>  14 __libc_csu_fini</span><br><span class="line">    46: 0000000000000000     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span> UND puts@@GLIBC_2.2.5</span><br><span class="line">    48: 00000000000006d4     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span>  15 _fini</span><br><span class="line">    49: 0000000000000000     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span> UND __libc_start_main@@GLIBC_</span><br><span class="line">    54: 0000000000000660   101 FUNC    GLOBAL<span class="built_in"> DEFAULT </span>  14 __libc_csu_init</span><br><span class="line">    56: 0000000000000530    43 FUNC    GLOBAL<span class="built_in"> DEFAULT </span>  14 _start</span><br><span class="line">    58: 000000000000063a    34 FUNC    GLOBAL<span class="built_in"> DEFAULT </span>  14 main</span><br><span class="line">    61: 0000000000000000     0 FUNC    WEAK  <span class="built_in"> DEFAULT </span> UND __cxa_finalize@@GLIBC_2.2</span><br><span class="line">    62: 00000000000004e8     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span>  11 _init</span><br></pre></td></tr></table></figure></p><ul><li>从这里看我们所写的main函数排在了58位,可见实际在mian()运行前确实运行了很多函数</li><li>在编译链接时,第一个入口函数地址是<code>_start</code></li></ul><p>借此我们可以编写一个自己的<code>_start</code>函数<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt; </span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="regexp">//m</span>ain()放前面是因为入口函数为自己定义的_start,这里的main()相当于一个子函数</span><br><span class="line">int main(void )</span><br><span class="line">&#123;</span><br><span class="line">printf(<span class="string">"hello world 1 !\n"</span>);</span><br><span class="line"></span><br><span class="line">return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 这里必须调用<span class="keyword">exit</span>()来善后,否则会core dump</span><br><span class="line">int _start(void) </span><br><span class="line">&#123; </span><br><span class="line">    printf(<span class="string">"hello world 2 !\n"</span>);</span><br><span class="line">main();</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>编译链接时不使用标准开始文件,而是使用自己写的<code>_start</code><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*gcc        -nostartfiles</span></span><br><span class="line"><span class="comment">                    Do not use the standard system startup files when linking.  The standard system</span></span><br><span class="line"><span class="comment">                    libraries are used normally, unless -nostdlib or -nodefaultlibs is used.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">gcc test<span class="selector-class">.c</span> -nostartfiles  &amp;&amp; ./<span class="selector-tag">a</span>.out</span><br><span class="line"></span><br><span class="line">&gt;   hello world <span class="number">2</span> !</span><br><span class="line">     hello world <span class="number">1</span> !</span><br></pre></td></tr></table></figure></p><p>再查看二进制文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">readelf -s a.out | grep FUNC</span><br><span class="line">   </span><br><span class="line">&gt;   1: 0000000000000000     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span> UND puts@GLIBC_2.2.5 (2)</span><br><span class="line">     2: 0000000000000000     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span> UND exit@GLIBC_2.2.5 (2)</span><br><span class="line">    22: 0000000000000000     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span> UND puts@@GLIBC_2.2.5</span><br><span class="line">    25: 00000000000003a7    31 FUNC    GLOBAL<span class="built_in"> DEFAULT </span>  10 _start</span><br><span class="line">    27: 0000000000000390    23 FUNC    GLOBAL<span class="built_in"> DEFAULT </span>  10 main</span><br><span class="line">    28: 0000000000000000     0 FUNC    GLOBAL<span class="built_in"> DEFAULT </span> UND exit@@GLIBC_2.2.5</span><br></pre></td></tr></table></figure></p><ul><li>相对比使用标准开始文件这里少了很多函数</li><li>由于链接时还是使用了系统库,所以程序还是能跑起来的</li></ul><p>另外一种方法是使用GNU特色之gcc关键字</p><blockquote><p>关键字<code>__attribute__</code>可以为函数（Function Attributes），变量（Variable Attributes）和结构成员（Type Attributes）赋属性。具体可以查看gcc手册（<a href="http://gcc.gnu.org/onlinedocs/）" target="_blank" rel="noopener">http://gcc.gnu.org/onlinedocs/）</a></p></blockquote><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关键字需要在定义之前</span></span><br><span class="line"></span><br><span class="line"> __attribute__((<span class="function"><span class="keyword">constructor</span>))<span class="title">void</span> <span class="title">before</span><span class="params">()</span>;</span></span><br><span class="line"></span><br><span class="line">__attribute__((<span class="function"><span class="keyword">destructor</span>))<span class="title">void</span> <span class="title">after</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">m</span><span class="params">()</span>__<span class="title">attribute__</span><span class="params">((constructor))</span> </span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"hello world  !\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*int _start(void) </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">void m()</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">printf("%d ",666);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&gt; 666 hello world  !</span></span><br></pre></td></tr></table></figure><p><a href="https://www.jianshu.com/p/4912a1dc8a50" target="_blank" rel="noopener">可执行文件格式说明</a><br><a href="https://www.jianshu.com/p/dda61084f9b5" target="_blank" rel="noopener">c语言中<strong>attribute</strong>的意义</a><br><a href="https://www.jb51.net/article/62360.htm" target="_blank" rel="noopener">C语言之没有main函数的helloworld示例</a><br><a href="https://bbs.csdn.net/topics/300103318#r_78088969" target="_blank" rel="noopener">一个c程序在执行main函数之前和main之后都做了那些事情啊？</a></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
    
      <category term="c" scheme="http://yoursite.com/tags/c/"/>
    
  </entry>
  
</feed>
